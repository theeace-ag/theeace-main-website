import{h as jt,j as V}from"https://app.framerstatic.com/chunk-2AHBAQI3.mjs";import{a as _t,b as Le,c as zt,d as Ue,e as Ht,f as Wt}from"https://app.framerstatic.com/chunk-R4KRXK5R.mjs";import{b as Bt,e as R}from"https://app.framerstatic.com/chunk-KOQ7F52D.mjs";import{a as $t,b as Kt,c as Jt,d as Gt}from"https://app.framerstatic.com/chunk-SE354WOV.mjs";import{a as ue}from"https://app.framerstatic.com/chunk-LPUCU4G7.mjs";import{f as ee,i as qt}from"https://app.framerstatic.com/chunk-R3IAJKKE.mjs";import{Kg as Vt,P as Q,Wf as le,Xf as Lt,Yf as M,_f as Ut,dg as Pt,eg as At,fg as Ot,gg as Ft,hg as Xe,ig as Ze,jg as Qe,kg as et,lg as E,md as Dt,mg as tt,ng as Mt,og as Ne,qa as kt}from"https://app.framerstatic.com/chunk-NBGN6U2B.mjs";import{e as xt}from"https://app.framerstatic.com/chunk-MVKO2TKJ.mjs";import{f as Nt}from"https://app.framerstatic.com/chunk-DXTSFT7O.mjs";import{ic as Et}from"https://app.framerstatic.com/chunk-Z44G2RQ4.mjs";import{$d as ce,Pt as Rt,Qt as Ye,Rt as It,St as Ee,Te as ke,Ve as wt,Xd as Z,ao as Ct,be as xe,ga as de,l as bt,mh as Tt}from"https://app.framerstatic.com/chunk-L7L7BWTW.mjs";import{a as De}from"https://app.framerstatic.com/chunk-XGYAAWSK.mjs";import{d as St}from"https://app.framerstatic.com/chunk-YYHHSCRK.mjs";import{p as z}from"https://app.framerstatic.com/chunk-65XKJBP2.mjs";import{d as vt,i as X}from"https://app.framerstatic.com/chunk-ZQUNXESX.mjs";import{a as Cr}from"https://app.framerstatic.com/chunk-NIDOI5EE.mjs";import{g as Ie}from"https://app.framerstatic.com/chunk-PI2QROPJ.mjs";import{e as gt,ea as yt,fa as Re,m as Ce,v as b}from"https://app.framerstatic.com/chunk-PNIOO2GU.mjs";import{a as f,b as Te}from"https://app.framerstatic.com/chunk-WNSBRACC.mjs";import{e as Tr,j as l}from"https://app.framerstatic.com/chunk-AHQIRSXG.mjs";async function ln(o){return qt.get(`/web/v1/sites/hostnames/${o}`)}var Yt=class extends Et{};var Rr=b("DocumentLoader"),rt=b("remote:verify"),Pe=class o{constructor(t,e){this.parser=t;this.settings=e;l(this,"canvasTreeVersion",0);l(this,"chunkingHints");this.canvasTreeVersion=this.parser.version,this.chunkingHints=this.parser.getChunkingHints()}static async createPartialParser(t,e){if(typeof t=="string"){let r=new Jt(t);return new o(r,e)}else{let r=new Gt(t);return new o(r,e)}}readFirstPage(){let t=!1,e=[];if(this.settings.activeNodeId&&(e.push(...this.parser.getPagesContainingId(this.settings.activeNodeId)),t=e.some(r=>V(this.parser.getShallowPage(r)))),!t){let r=this.parser.getShallowPages(),n=jt(r,this.parser.getHomePageNodeID());e.push(n.id);let i=0,s;for(let a of r){if(ke(a,!0)&&i++,i>1)break;wt(a,!0)&&(s??=a.id)}i===1&&s&&s!==n.id&&e.push(s)}return Rr.debug("loadPartialDocument():",e),Wt(this.parser,e,this.settings.treeServices)}getScopesToLoad(){return this.parser.getPagesToLoad()}getParsedPageById(t){return this.parser.getParsedPageById(t)}buildPage(t){if(!t)return;let e=[],r=rt.isLoggingTraceMessages()?[]:void 0,n=M(t,this.parser.root.id,{extraChecksAndFixes:!0,errors:e,warnings:r});if(n&&Ue(n,e),e.length>0&&rt.warn("errors loading server tree: "+e.join(`
`)),r&&r.length>0&&rt.trace("warnings loading server tree: "+r.join(`
`)),!!n)return n}};var nt=b("app");function Rn(o){return o.treeReflectsDocument?Ir(o.tree):null}function Ir(o){return o.toJS()}function In(o){function t(e){let{__class:r,width:n,height:i,top:s,bottom:a,left:d,right:c}=e,{children:u}=e;return u?(u=u.map(t),{__class:r,width:n,height:i,top:s,bottom:a,left:d,right:c,children:u}):e.styledText?{__class:r,width:n,height:i,top:s,bottom:a,left:d,right:c,text:e.styledText.blocks.map(h=>h.text)}:{__class:r,width:n,height:i,top:s,bottom:a,left:d,right:c}}return t(o.tree.toJS().root)}function xn(o){let t,e=new XMLHttpRequest;e.open("GET",o.toString(),!1);try{e.send(),t=JSON.parse(e.responseText)}catch(r){nt.error(`Retrieving document \u201C${o}\u201D failed. (${r})`)}return it(t)}function Xt(o){Ie.isTest||o.forEach(t=>{nt.warn("[repaired]",t)})}function it(o){let t=[];try{let e=Le(o,t);return Xt(t),e}catch(e){throw Xt(t),nt.warn("tree failed to verify:",e),e}}var he=class extends Error{constructor(){super("cancelled"),this.name="CancelledError"}},Ae=class{constructor(t){this.requestIdleCallback=t;l(this,"resumePromiseResolve");l(this,"resumePromise");l(this,"backgroundMode",!1);l(this,"done",!1);l(this,"firstError");l(this,"debugStepListener")}debugResumeOneStep(){this.resume(),this.pause()}currentMode(){return this.backgroundMode?"slow":"fast"}isDone(){return!!this.firstError||this.done}isSuccess(){return!this.firstError&&this.done}isCancelled(){return!!this.firstError&&this.firstError instanceof he}isError(){return!!this.firstError&&!(this.firstError instanceof he)}getError(){return this.firstError}cancel(){this.isDone()||(this.firstError=new he)}error(t){return this.isDone()||(this.firstError=t),t}pause(){this.firstError||this.resumePromise||(this.resumePromise=new Promise(t=>{this.resumePromiseResolve=t}))}resume(){let t=this.resumePromiseResolve;t&&(this.resumePromise=void 0,this.resumePromiseResolve=void 0,t())}isPaused(){return!!this.resumePromise}fast(){this.backgroundMode=!1}slow(){this.backgroundMode=!0}async run(t){f(!this.isDone(),"task is already done");try{await t()}catch(e){throw e instanceof Error?this.error(e):this.error(new Error(String(e??"Unknown Error")))}finally{this.done=!0}}async sleep(t){if(this.debugStepListener?.(),await gt(t),this.resumePromise&&await this.resumePromise,this.debugStepListener?.(),this.resumePromise&&await this.resumePromise,this.firstError)throw this.firstError}async yield(){if(this.debugStepListener?.(),this.resumePromise?await this.resumePromise:this.backgroundMode?await new Promise(t=>{this.requestIdleCallback?this.requestIdleCallback(t):typeof requestIdleCallback=="function"?requestIdleCallback(t):setTimeout(t,0)}):await Re(),this.resumePromise&&await this.resumePromise,this.debugStepListener?.(),this.resumePromise&&await this.resumePromise,this.firstError)throw this.firstError}};var S=b("DocumentLoader"),Oe=10,fe=1e3;function H(o){return o<1024*.75?`${Math.round(o)}b`:o<1024*1024*.75?`${(o/1024).toFixed(2)}kb`:`${(o/1024/1024).toFixed(2)}Mb`}function I(o){return o<200?`${o.toFixed(1)}ms`:o<20*1e3?`${(o/1e3).toFixed(3)}s`:`${Math.round(o/1e3)}s`}var W=class extends Bt{constructor(e,r,n){super();this.treeVersion=e;this.documentURL=r;this.settings=n;l(this,"scheduler");l(this,"retryCount",0);l(this,"scopesToLoad",new Set);l(this,"prioritizedScopeIds",new Set);l(this,"currentLoadingScope");l(this,"partialParser");l(this,"canvasTreeVersion",0);l(this,"documentSize",0);l(this,"loadedFirstScope",!1);l(this,"loadingDuration",0);l(this,"parsingDuration",0);l(this,"debugPaused",!1);l(this,"loadingScopesPaused",!1);l(this,"loadAllDataPriority",0);l(this,"updatePauseResumeState",()=>{if(!this.loadedFirstScope){this.scheduler.fast(),this.scheduler.resume();return}let e=this.loadAllDataPriority>0||this.prioritizedScopeIds.size>0,r=this.loadingScopesPaused||this.debugPaused;e?this.scheduler.fast():this.scheduler.slow(),e||!r||this.scopesToLoad.size<=0?this.scheduler.resume():this.scheduler.pause()});l(this,"tree");l(this,"loadCallbacksPerScope",new Map);l(this,"addedByDiff",new Set);l(this,"removedByDiff",new Set);this.scheduler=new Ae(n.requestIdleCallback),S.debug("new:",this.treeVersion,this.documentURL)}pauseLoadingScopes(){this.loadingScopesPaused||(this.loadingScopesPaused=!0,S.debug("pauseLoadingScopes"),this.updatePauseResumeState())}resumeLoadingScopes(){this.loadingScopesPaused&&(this.loadingScopesPaused=!1,S.debug("resumeLoadingScopes"),this.updatePauseResumeState())}prioritizeLoadingAllData(e){let r="preload"in e&&e.preload;if(r&&z.isOn("debugEditWhileNeverLoadingRest"))return()=>{};let n=performance.now(),i=this.numberOfScopesToLoad();this.loadAllDataPriority=Math.max(1,this.loadAllDataPriority+1),S.debug("prioritizeLoadingScopes:",this.loadAllDataPriority),this.updatePauseResumeState();let s=r||"doNotTrack"in e&&e.doNotTrack,a=!1,d=s?void 0:this.afterAllDataLoaded(()=>{if(a)return;f("operationName"in e,"operationName is required");let u=performance.now()-n;Nt("fulltree_force_load",{operationName:e.operationName,durationMs:Math.round(u),background:e.operationInBackground,shallowScopesCount:i})});return()=>{a||(a=!0,d?.(),this.stopPrioritizingLoadingAllData())}}stopPrioritizingLoadingAllData(){this.loadAllDataPriority-=1,S.debug("stopPrioritizingLoadingScopes:",this.loadAllDataPriority),this.updatePauseResumeState()}debugPause(){this.debugPaused||(this.debugPaused=!0,S.debug("debugPause"),this.updatePauseResumeState())}debugResume(){this.debugPaused&&(this.debugPaused=!1,S.debug("debugResume"),this.updatePauseResumeState())}isDebugPaused(){return this.debugPaused}afterAllDataLoaded(e){let r=this.scopesToLoad.size===0;if(e){if(r){let n=!1;return queueMicrotask(()=>{n||e()}),()=>{n=!0}}return this.once("loadedAllData",e),()=>{this.off("loadedAllData",e)}}return r?Promise.resolve():new Promise(n=>{this.once("loadedAllData",n)})}async start(){await this.scheduler.run(async()=>{S.debug("start"),R("parsingInit"),this.updatePauseResumeState();let e=performance.now(),r=await this.loadData();if(this.loadingDuration=performance.now()-e,await this.scheduler.yield(),!this.settings.partialParsing||typeof r=="string"&&!Kt(r))return this.parseFullDocumentSync(r);let n=await this.loadDocumentVersion(r);for(await this.scheduler.yield(),this.tree=await this.loadFirstTree(n),this.loadedFirstScope=!0,this.updatePauseResumeState(),await this.scheduler.yield(),R("parsingResume");this.hasNextScopeToLoad();)await this.loadNextScopeAsync(),await this.scheduler.yield();await this.emitWrapped(()=>{f(this.tree,"tree must have been set"),this.tree.setService("loader",void 0),this.emit("loadedAllData")}),S.debug("done",H(this.documentSize),"loading:",I(this.loadingDuration),"parsing:",I(this.parsingDuration))})}async loadData(){if(this.settings.loadedData)return this.settings.loadedData;S.debug("Document in cache is not up to date. Tree version:",this.treeVersion);let e=this.settings.initData,r=e?.version===this.treeVersion,n=e?.prefetchPromise;if(e&&delete e.prefetchPromise,r&&n){S.debug("loadData: prefetch");let d=await n;if(n.then(c=>c.duration).then(c=>{R("dataLoad",c)}),await this.scheduler.yield(),d.buffer){S.debug("loadData: prefetch bytes parser");let c=await d.buffer;return await this.scheduler.yield(),d.status<200||d.status>=300?this.handleErrorAndRetry(d.status,"Error loading project data"):new Uint8Array(c)}if(d.text){let c=await d.text;return await this.scheduler.yield(),d.status<200||d.status>=300?this.handleErrorAndRetry(d.status,c):c}}S.debug("loadData: fetch");let i;this.settings.refreshAccessToken&&(i=await this.settings.refreshAccessToken({}),await this.scheduler.yield());let s=await fetch(this.documentURL,i);await this.scheduler.yield();function a(d){if(!d.body)return!1;let c=new URLSearchParams(window.location.search).has("bytes"),u=document.cookie.includes("bytes-parser=true"),h=parseInt(d.headers.get("Uncompressed-Content-Length")??"0",10)>2e8;return c&&(document.cookie="bytes-parser=true; path=/;"),c||u||h}if(R("dataLoad"),s.status<200||s.status>=300){let d=await s.text();return this.handleErrorAndRetry(s.status,d)}if(a(s)){S.debug("loadData: using streaming parser");let d=await s.arrayBuffer();return new Uint8Array(d)}else{S.debug("loadData: using text parser");let d=await s.text();return await this.scheduler.yield(),d}}async handleErrorAndRetry(e,r){let n=!1;try{n=JSON.parse(r).retry}catch{}if(n&&this.retryCount<Oe)return S.debug("onErrorStatusLoaded, retry:",this.retryCount),await this.scheduler.sleep(this.retryCount*fe+Math.random()*fe),this.retryCount+=1,this.loadData();throw Error(n?"Too many retries":`Fetch Error: ${e} - ${r}`)}parseFullDocumentSync(e){if(typeof e!="string")throw new Error("Full document sync parsing requires string data, not ReadableStream");let r=performance.now();this.documentSize=e.length;let n=JSON.parse(e);if(!vt(n.version))throw Error("cannot read document version");if(this.canvasTreeVersion=n.version,S.debug("parseFullDocumentSync",this.canvasTreeVersion,H(this.documentSize),I(this.loadingDuration)),this.emit("loadedDocumentVersion",n.version),this.scheduler.isDone())return;let i=it(n);this.emit("loadedFirstData",i),!this.scheduler.isDone()&&(this.emit("loadedAllData"),this.parsingDuration+=performance.now()-r,R("parsingFirstPage"),S.debug("done",H(this.documentSize),"loading:",I(this.loadingDuration),"parsing:",I(this.parsingDuration)))}hasLoadedScope(e){let r=this.scopesToLoad.has(e),n=this.currentLoadingScope?.id===e;return!r&&!n}numberOfScopesToLoad(){return this.scopesToLoad.size}prioritizeLoadingScope(e,r){let n,i;if(typeof r=="function")this.addScopeLoadCallback(e,r);else if(r&&"onLoaded"in r)this.addScopeLoadCallback(e,r.onLoaded),i=r;else{let s=yt();n=s,this.addScopeLoadCallback(e,s.resolve),i=r}if(!(i?.preload&&z.isOn("debugEditWhileNeverLoadingRest")))return this.scopesToLoad.has(e)&&(this.prioritizedScopeIds.add(e),this.updatePauseResumeState(),this.addScopeLoadCallback(e,this.updatePauseResumeState)),n}nextScopeIdToLoad(){for(let r of this.prioritizedScopeIds)if(this.prioritizedScopeIds.delete(r),!!this.scopesToLoad.has(r))return this.scopesToLoad.delete(r),this.scheduler.fast(),r;let e=this.loadAllDataPriority>0;this.settings.loadInBackground&&!e?this.scheduler.slow():this.scheduler.fast();for(let r of this.scopesToLoad)return this.scopesToLoad.delete(r),r;throw Error("No next scope to load")}async loadDocumentVersion(e){let r=performance.now(),n=await Pe.createPartialParser(e,this.settings);return typeof e=="string"?this.documentSize=e.length:this.documentSize=0,this.canvasTreeVersion=n.canvasTreeVersion,this.parsingDuration+=performance.now()-r,S.debug("loadDocumentVersion",this.canvasTreeVersion,typeof e=="string"?H(this.documentSize):"stream",I(this.loadingDuration)),await this.emitWrapped(()=>{if(this.scheduler.isDone())return;let i=performance.now();this.emit("loadedDocumentVersion",this.canvasTreeVersion),this.parsingDuration+=performance.now()-i}),this.partialParser=n,n}async loadFirstTree(e){let r=performance.now(),n=e.readFirstPage();this.scopesToLoad=e.getScopesToLoad();for(let i of this.scopesToLoad){let s=n.get(i);s&&(s.cache.isShallowLoad=!0)}return this.parsingDuration+=performance.now()-r,S.debug("loadFirstTree",I(this.parsingDuration)),await this.emitWrapped(()=>{if(this.scheduler.isDone())return;let i=performance.now();n.setService("loader",this),n.chunkingHints=e.chunkingHints,this.emit("loadedFirstData",n),R("parsingFirstPage"),this.parsingDuration+=performance.now()-i}),n}hasNextScopeToLoad(){return this.scopesToLoad.size>0}async loadNextScopeAsync(){f(!this.currentLoadingScope,"already have a currently loading scope");let e=this.nextScopeIdToLoad();this.currentLoadingScope=this.createLoadingScope(e);let r=await this.currentLoadingScope.run(this.scheduler);S.debug("loadScopeAsync:",e,I(r.duration),"scheduler mode:",this.scheduler.currentMode()),r.hasNode()&&await this.emitWrapped(()=>{if(this.scheduler.isDone())return;let n=performance.now(),i=r.take();this.currentLoadingScope=void 0,i&&(this.emit("loadedScope",i),this.parsingDuration+=r.duration+performance.now()-n,this.signalScopeLoadCallbacks(i.id))})}createLoadingScope(e){return f(this.partialParser,"loadScope before the parser is available"),new st(e,this.partialParser)}loadScope(e){if(this.currentLoadingScope?.id===e){let n=this.currentLoadingScope.force();return this.parsingDuration+=n.duration,this.currentLoadingScope=void 0,n.take()}if(this.prioritizedScopeIds.delete(e),!this.scopesToLoad.has(e))return;this.scopesToLoad.delete(e);let r=this.createLoadingScope(e).force();return this.parsingDuration+=r.duration,S.debug("loadScope:",e,I(r.duration)),this.signalScopeLoadCallbacks(e),r.take()}addScopeLoadCallback(e,r){if(!r)return;if(this.hasLoadedScope(e)){setTimeout(r);return}let n=this.loadCallbacksPerScope.get(e)??[];n.push(r),this.loadCallbacksPerScope.set(e,n)}signalScopeLoadCallbacks(e){setTimeout(()=>{let r=this.loadCallbacksPerScope.get(e);if(r){for(let n of r)n();this.loadCallbacksPerScope.delete(e)}})}async emitWrapped(e){this.settings.asyncEventWrapper?(await this.scheduler.yield(),await this.settings.asyncEventWrapper(e)):(await this.scheduler.yield(),e())}resetTreeForRecovery(e){e.setService("loader",this);for(let r of this.scopesToLoad){let n=e.get(r);n&&(n.cache.isShallowLoad=!0)}this.tree=e}async nodeIdsToLoad(){let e=performance.now(),r=new Set;if(!this.partialParser)return r;let n=performance.now();for(let i of this.scopesToLoad){performance.now()-n>50&&(await Re(),n=performance.now());let s=this.partialParser.getParsedPageById(i);Zt(r,s)}for(let i of this.addedByDiff)r.add(i);for(let i of this.removedByDiff)r.delete(i);return S.debug("nodeIdsToLoad",r.size,I(performance.now()-e)),r}addNodeChanges(e){for(let r of e){let n=r.id;r.added?(this.addedByDiff.add(n),this.removedByDiff.delete(n)):r.removed&&(this.addedByDiff.delete(n),this.removedByDiff.add(n))}}};function Zt(o,t){if(t&&(o.add(t.id),!!t.children))for(let e of t.children)Zt(o,e)}var $=class{constructor(t,e){this.node=t;this.duration=e}hasNode(){return!!this.node}take(){let t=this.node;return this.node=void 0,t}},st=class{constructor(t,e){this.id=t;this.parser=e;l(this,"data");l(this,"loadedScope")}async run(t){if(this.loadedScope)return this.loadedScope;let e=performance.now();this.data=this.parser.getParsedPageById(this.id);let r=performance.now()-e;if(await t.yield(),this.loadedScope)return this.loadedScope;let n=performance.now(),i=this.parser.buildPage(this.data);return i&&(i.cache.isShallowLoad=!1),this.loadedScope=new $(i,r+performance.now()-n),this.loadedScope}force(){if(this.loadedScope)return this.loadedScope;let t=performance.now();this.data||(this.data=this.parser.getParsedPageById(this.id));let e=this.parser.buildPage(this.data);return e&&(e.cache.isShallowLoad=!1),this.loadedScope=new $(e,performance.now()-t),this.loadedScope}};var pe=class{constructor(){l(this,"cache",new Map)}set(t,e,r){let n=this.cache.get(t);n||(n=new Map,this.cache.set(t,n)),n.set(e,r)}getSubMap(t){return this.cache.get(t)}get(t,e){return this.cache.get(t)?.get(e)}clear(){this.cache.clear()}};var Fe=class{constructor(t){l(this,"seqs",[]);l(this,"idxs",[]);l(this,"maxSize");this.maxSize=t?.maxSize}clear(){this.seqs=[],this.idxs=[]}get(t){let e=this.seqs.length;if(e===0)return 0;let r=Qt(this.seqs,t);return r<e&&this.seqs[r]===t?this.idxs[r]:0}add(t,e){if(this.maxSize&&this.seqs.length>=this.maxSize&&this.seqs[0]>t)return;let i=Qt(this.seqs,t);if(i<this.seqs.length&&this.seqs[i]===t){e<this.idxs[i]&&(this.idxs[i]=e,this.propagateLeftFrom(i));return}this.seqs.splice(i,0,t),this.idxs.splice(i,0,e),i+1<this.idxs.length&&(this.idxs[i]=Math.min(this.idxs[i],this.idxs[i+1])),this.propagateLeftFrom(i),this.evict()}evict(){if(this.maxSize){let t=this.seqs.length-this.maxSize;t>0&&(this.seqs.splice(0,t),this.idxs.splice(0,t))}}propagateLeftFrom(t){let e=this.idxs[t];for(let r=t-1;r>=0&&!(this.idxs[r]<=e);r--)this.idxs[r]=e}__snapshot(){return this.seqs.map((t,e)=>({seq:t,idx:this.idxs[e]}))}};function Qt(o,t){let e=0,r=o.length;for(;e<r;){let n=e+r>>>1;o[n]<t?e=n+1:r=n}return e}var me=class{constructor(t){this.buffer=t;l(this,"view");l(this,"decoder",new TextDecoder);l(this,"byteOffset",0);this.view=new DataView(t.buffer,t.byteOffset,t.byteLength)}align(t){let e=(t-this.byteOffset%t)%t;this.byteOffset+=e}endOfFile(){return this.byteOffset>=this.buffer.byteLength}readUint8(){let t=this.view.getUint8(this.byteOffset);return this.byteOffset+=1,t}readUint16(){let t=this.view.getUint16(this.byteOffset,!0);return this.byteOffset+=2,t}readVarUint(){let t=0,e=0;for(;;){let r=this.readUint8();if(t+=(r&127)*2**e,(r&128)===0)break;if(e+=7,e>53)throw new Error("VarUint is too big")}return t}readString(){let t=this.readVarUint(),e=this.buffer.subarray(this.byteOffset,this.byteOffset+t);return this.byteOffset+=t,this.decoder.decode(e)}readTypedArray(t){let e=this.readVarUint(),r=t.BYTES_PER_ELEMENT;this.align(r);let n=this.byteOffset+this.buffer.byteOffset,i=e*r;if(n%r!==0){let s=new ArrayBuffer(i);return new Uint8Array(s).set(new Uint8Array(this.buffer.buffer,n,i)),this.byteOffset+=i,new t(s,0,e)}return this.byteOffset+=i,new t(this.buffer.buffer,n,e)}};var xr=1024*1024,ge=class{constructor(t=new Uint8Array(xr)){this.buffer=t;l(this,"view");l(this,"encoder",new TextEncoder);l(this,"byteOffset",0);this.view=new DataView(this.buffer.buffer)}ensureCapacity(t){let e=this.byteOffset+t;if(e>this.buffer.length){let r=this.buffer.length*2;for(;r<e;)r*=2;let n=new Uint8Array(r);n.set(this.buffer),this.buffer=n,this.view=new DataView(this.buffer.buffer)}}align(t){let e=this.byteOffset+t-1&~(t-1);this.ensureCapacity(e-this.byteOffset),this.byteOffset=e}writeUint8(t){return this.ensureCapacity(1),this.view.setUint8(this.byteOffset,t),this.byteOffset+=1,1}writeUint16(t){this.ensureCapacity(2),this.view.setUint16(this.byteOffset,t,!0),this.byteOffset+=2}writeVarUint(t){let e=t;for(;e>=128;)this.writeUint8(e%128|128),e=Math.floor(e/128);this.writeUint8(e)}writeString(t){let e=this.encoder.encode(t);this.writeVarUint(e.length),this.ensureCapacity(e.length),this.buffer.set(e,this.byteOffset),this.byteOffset+=e.length}writeTypedArray(t,e=t.length){this.writeVarUint(e);let r=this.preallocateTypedArray(t.BYTES_PER_ELEMENT,e),n=new Uint8Array(t.buffer,t.byteOffset,r);this.buffer.set(n,this.byteOffset),this.byteOffset+=r}preallocateTypedArray(t,e){this.align(t);let r=e*t;return this.ensureCapacity(r),r}writeBytes(t){this.ensureCapacity(t.length),this.buffer.set(t,this.byteOffset),this.byteOffset+=t.length}getBuffer(){return this.buffer.slice(0,this.byteOffset)}};function ye(o){if(o===Uint8Array)return"U8";if(o===Uint16Array)return"U16";if(o===Uint32Array)return"U32";if(o===Float64Array)return"F64";throw new Error("Invalid array name")}var te=class{constructor(t,e,r){this.capacity=t;l(this,"buffer");l(this,"length",0);r?(this.buffer=r.buffer,this.length=r.length,f(this.buffer.length===this.capacity,"Buffer capacity mismatch:",this.buffer.length,"!=",this.capacity)):this.buffer=new e(t)}push(t){this.buffer[this.length]=t,this.length+=1}};var kr=2**17,re=class{constructor(t,e=kr){this.arrayConstructor=t;this.bucketSize=e;l(this,"buckets",[]);l(this,"_length",0);l(this,"bucketShift");l(this,"bucketMask");f((e&e-1)===0,`Bucket size must be a power of 2, got: ${e}`),this.bucketShift=Math.log2(e),this.bucketMask=e-1}get type(){return`BucketedColumn(${ye(this.arrayConstructor)})`}add(t){let e=this.buckets[this.buckets.length-1];(!e||e.length>=e.capacity)&&(e=new te(this.bucketSize,this.arrayConstructor),this.buckets.push(e)),e.push(t);let r=this._length;return this._length+=1,r}get(t){f(t>=0&&t<this._length,"index out of bounds");let e=t>>this.bucketShift,r=t&this.bucketMask,n=this.buckets[e];return f(n,"invalid bucket index"),n.buffer[r]}get length(){return this._length}slice(t,e){t<0&&(t=this.length+t),e<0&&(e=this.length+e);let r=t>>this.bucketShift,n=e>>this.bucketShift,i=Math.min(this.length,e)-t;if(i<=0)return[];let s=Array.from({length:i}),a=0,d=t&this.bucketMask,c=this.buckets[r];if(r===n){let m=e&this.bucketMask;for(let p=d;p<m;++p)s[a++]=c.buffer[p];return s}for(let m=d;m<this.bucketSize;++m)s[a++]=c.buffer[m];for(let m=r+1;m<n;++m){let p=this.buckets[m];for(let g=0;g<p.length;++g)s[a++]=p.buffer[g]}let u=e&this.bucketMask,h=this.buckets[n];if(h)for(let m=0;m<u;++m)s[a++]=h.buffer[m];return s}serialize(t){t.writeVarUint(this.length),t.preallocateTypedArray(this.arrayConstructor.BYTES_PER_ELEMENT,this.length);for(let e of this.buckets)t.writeBytes(new Uint8Array(e.buffer.buffer,e.buffer.byteOffset,e.length*this.arrayConstructor.BYTES_PER_ELEMENT))}deserialize(t){let e=t.readTypedArray(this.arrayConstructor);this._length=e.length;let r=0;for(r=0;r<e.length-this.bucketSize;r+=this.bucketSize){let n=e.subarray(r,r+this.bucketSize);this.buckets.push(new te(this.bucketSize,this.arrayConstructor,{buffer:n,length:n.length}))}if(r<e.length){let n=new te(this.bucketSize,this.arrayConstructor);for(;r<e.length;++r)n.push(e[r]);this.buckets.push(n)}}};var be=class o{constructor(t,e){this.arrayConstructor=t;l(this,"uniques",[]);l(this,"maxUniques");l(this,"indices");l(this,"count",0);l(this,"lookup");l(this,"cursor",0);if(this.indices=new re(t,e),t===Uint8Array)this.maxUniques=2**8-1;else if(t===Uint16Array)this.maxUniques=2**16-1;else if(t===Uint32Array)this.maxUniques=2**32-1;else if(t===Float64Array)this.maxUniques=Number.MAX_SAFE_INTEGER;else throw new Error(`Unsupported array constructor: ${t.name}`)}get type(){return`LazyNormalizedBucketedColumn(ref: ${ye(this.arrayConstructor)})`}static withBuckets({buffer:t,size:e}){return{create:()=>new o(t,e)}}hydrateThrough(t){for(this.lookup||(this.lookup=new Map);this.cursor<=t;++this.cursor){let e=this.uniques[this.cursor];this.lookup.set(e,this.cursor)}}indexOfExisting(t){if(this.lookup?.has(t))return this.lookup.get(t);for(;this.cursor<this.uniques.length;++this.cursor){let e=this.uniques[this.cursor];if(this.lookup??=new Map,this.lookup.set(e,this.cursor),Object.is(e,t))return this.cursor}}add(t){let e=this.indexOfExisting(t);e===void 0&&(f(this.uniques.length<this.maxUniques,"limit reached for unique values"),e=this.uniques.length,this.uniques.push(t),this.lookup??=new Map,this.lookup.set(t,e),this.cursor=this.uniques.length);let r=this.count;return this.indices.add(e),this.count=r+1,r}get(t){f(t>=0&&t<this.count,"index out of bounds");let e=this.indices.get(t);return this.uniques[e]}slice(t,e){let r=Math.max(0,e-t),n=new Array(r),i=this.indices.slice(t,e);for(let s=0;s<r;++s)n[s]=this.uniques[i[s]];return n}get length(){return this.count}serialize(t){t.writeString(JSON.stringify(this.uniques)),this.indices.serialize(t)}deserialize(t){let e=t.readString();this.indices.deserialize(t),this.uniques=JSON.parse(e),this.count=this.indices.length,this.lookup=void 0,this.cursor=0}rehydrate(){this.cursor<this.uniques.length&&this.hydrateThrough(this.uniques.length-1)}};var ne=class{constructor(t=1024){l(this,"uniques",[]);l(this,"indices");l(this,"count",0);l(this,"lookup");l(this,"cursor",0);this.indices=new Uint32Array(t)}get type(){return"LazyNormalizedColumn"}ensureCapacity(t){if(t<=this.indices.length)return;let e=this.indices.length||1;for(;e<t;)e<<=1;let r=new Uint32Array(e);r.set(this.indices),this.indices=r}hydrateThrough(t){for(this.lookup||(this.lookup=new Map);this.cursor<=t;++this.cursor){let e=this.uniques[this.cursor];this.lookup.set(e,this.cursor)}}indexOfExisting(t){if(this.lookup?.has(t))return this.lookup.get(t);for(;this.cursor<this.uniques.length;++this.cursor){let e=this.uniques[this.cursor];if(this.lookup??=new Map,this.lookup.set(e,this.cursor),Object.is(e,t))return this.cursor}}add(t){let e=this.indexOfExisting(t);e===void 0&&(e=this.uniques.length,this.uniques.push(t),this.lookup??=new Map,this.lookup.set(t,e),this.cursor=this.uniques.length);let r=this.count;return this.ensureCapacity(r+1),this.indices[r]=e,this.count=r+1,r}get(t){if(t<0||t>=this.count)throw RangeError("index out of bounds");return this.uniques[this.indices[t]]}slice(t,e){let r=Math.max(0,e-t),n=new Array(r);for(let i=0;i<r;++i)n[i]=this.uniques[this.indices[t+i]];return n}get length(){return this.count}serialize(t){t.writeString(JSON.stringify(this.uniques)),t.writeTypedArray(this.indices.subarray(0,this.count))}deserialize(t){let e=t.readString(),r=t.readTypedArray(Uint32Array);this.uniques=JSON.parse(e),this.indices=new Uint32Array(r),this.count=this.indices.length,this.lookup=void 0,this.cursor=this.uniques.length}rehydrate(){this.cursor<this.uniques.length&&this.hydrateThrough(this.uniques.length-1)}};var A=class A{constructor(){l(this,"columns",{client:be.withBuckets({buffer:Uint32Array}).create(),seq:new re(Float64Array),id:new ne,key:new ne,value:new ne,user:be.withBuckets({buffer:Uint8Array}).create()})}getRowInternal(t){return{client:this.columns.client.get(t),seq:this.columns.seq.get(t),id:this.columns.id.get(t),key:this.columns.key.get(t),value:this.columns.value.get(t),user:this.columns.user.get(t)}}getRow(t){if(t<0||t>=this.columns.client.length)throw new Error("Index out of bounds");return this.getRowInternal(t)}getRows(t=0,e=this.columns.client.length){if(t<0||e>this.columns.client.length||t>e)throw new Error("Index out of bounds");let r=new Array(e-t);for(let n=t;n<e;n++)r[n-t]=this.getRowInternal(n);return r}toBuffer(){let t=new ge;t.writeString(A.MAGIC),t.writeUint16(A.VERSION);let e;for(e in this.columns){let r=this.columns[e];t.writeString(e),t.writeString(r.type),r.serialize(t)}return t.getBuffer()}fromBuffer(t){let e=new me(t),r=e.readString();f(r===A.MAGIC,"Not a framer document:",r);let n=e.readUint16();for(f(n===A.VERSION,"Version mismatch:",n,"(actual)","!=",A.VERSION,"(expected)");!e.endOfFile();){let i=e.readString(),s=this.columns[i];f(s,"Column",i,"not found");let a=e.readString();f(a===s.type,"Column type does not match:",a,"(actual)","!=",s.type,"(expected)"),s.deserialize(e)}}get length(){return this.columns.client.length}};l(A,"VERSION",1),l(A,"MAGIC","FRAMERCRDT");var ie=A;function at(o,t){let e=o.length,r=t.length,n=Array.from({length:e+1},()=>new Array(r+1).fill(0));for(let d=e-1;d>=0;--d)for(let c=r-1;c>=0;--c)o[d]===t[c]?n[d][c]=n[d+1][c+1]+1:n[d][c]=Math.max(n[d+1][c],n[d][c+1]);let i=[],s=0,a=0;for(;s<e&&a<r;)o[s]===t[a]?(s+=1,a+=1):n[s+1][a]>n[s][a+1]?(i.push({operation:"delete",index:s}),s+=1):(i.push({operation:"insert",index:a,value:t[a]}),a+=1);for(;s<e;)i.push({operation:"delete",index:s}),s+=1;for(;a<r;)i.push({operation:"insert",index:a,value:t[a]}),a+=1;return i}function dt(o,t,e,r,n,i){let s=t-o;if(s<1e-8)return o+s/2;let a;if(r!==null&&r===e&&n!==null){let c=i-n;a=Math.min(.01*c,.5)}else a=.01+((e^i)>>>0)%100/100*.98;let d=o+s*a;return d<=o||d>=t?o+s/2:d}var rr=new ArrayBuffer(8),Er=new Float64Array(rr),er=new Uint32Array(rr),Nr=o=>(Er[0]=o,[er[0]>>>0,er[1]>>>0]),tr=(o,t)=>o<<t|o>>>32-t,Ve=(o,t)=>{let e=Math.imul(t,3432918353);e=tr(e,15),e=Math.imul(e,461845907);let r=o^e;return r=tr(r,13),Math.imul(r,5)+3864292196>>>0},ct=o=>{let t=o;return t^=t>>>16,t=Math.imul(t,2246822507),t^=t>>>13,t=Math.imul(t,3266489909),(t^t>>>16)>>>0},Me=o=>{let t=0,e=0;for(;e+1<o.length;e+=2){let r=o.charCodeAt(e)|o.charCodeAt(e+1)<<16;t=Ve(t,r)}return e<o.length&&(t=Ve(t,o.charCodeAt(e))),ct(t^o.length)},Dr=2097151,Lr=o=>{let t=2654435769,e=2135587861,r=i=>{t=Ve(t,i),e=Ve(e,i^2915580697)},n=i=>{switch(typeof i){case"string":r(Me(i));break;case"number":{let[s,a]=Nr(i);r(s),r(a)}break;case"boolean":r(i?1:0);break;case"undefined":r(2);break;case"symbol":r(Me(i.description??""));break;case"bigint":r(Number(i&0xffffffffn)),r(Number(i>>32n&0xffffffffn));break;case"function":r(Me(i.toString()));break;case"object":{if(i===null){r(7);break}if(Array.isArray(i)){let a=i.length;if(r(165),r(a),a>32){for(let c=0;c<8;++c)n(i[c]);for(let c=a-8;c<a;++c)n(i[c]);let d=(a-16)/16|0;for(let c=8;c<a-8;c+=d)n(i[c])}else for(let d=0;d<a;++d)n(i[d]);break}r(195);let s=0;for(let a in i){if(++s>32)break;r(Me(a)),n(i[a])}r(s);break}default:r(13)}};return n(o),t=ct(t),e=ct(e),(t&Dr)*4294967296+e},lt=Lr;function Se(o){return typeof o=="object"&&o!==null}function Ur(o,t){if(o.length!==t.length)return!1;let e=o.length;for(let r=0;r<e;r++)if(o[r]!==t[r])return!1;return!0}var w="$deleted",q="$keep",qe="$keep_value";function Pr(o,t,e,r){return o===e?t>r:o>e}function Ar(o,t){return o.seq===t.seq?o.client-t.client:o.seq-t.seq}function ut(o){if(typeof o=="string"&&o.startsWith("arr("))return o.slice(4,-1)}function ve(o){if(typeof o=="string"&&o.startsWith("obj("))return o.slice(4,-1)}function nr(o){return`arr(${o})`}function K(o){return`obj(${o})`}var J=class o{constructor({client:t,user:e}){l(this,"_seq",0);l(this,"table",new ie);l(this,"latest",new pe);l(this,"resolved",new Map);l(this,"arraySortedIndicesCache",new Map);l(this,"parentIdOverrides",new Map);l(this,"parentIdHistoryByNodeId",new Map);l(this,"minIndexCache",new Fe({maxSize:1e3}));l(this,"client");l(this,"user");l(this,"getIdFromObject");l(this,"transactionSeq");l(this,"readTransactionLevel",0);l(this,"foundIds",new Set);this.client=t,this.user=e,this.reset()}reset(){this.latest.clear(),this.resolved.clear(),this._seq=0,this.transactionSeq=void 0,this.table=new ie,this.arraySortedIndicesCache.clear(),this.minIndexCache.clear()}fromBuffer(t){f(this.transactionSeq===void 0,"You cannot intialise from a buffer during a transaction"),this.reset(),this.table.fromBuffer(t),this.indexRowsOptimized(),this.fixHierarchy()}toBuffer(){return this.table.toBuffer()}get seq(){return this._seq}getRows(t,e){return this.table.getRows(t,e)}getRowsSorted(){return this.getRows().sort(Ar)}getFirstRowForSeq(t){return this.minIndexCache.get(t)}indexRowsOptimized(){let{client:t,id:e,key:r,seq:n,value:i}=this.table.columns;for(let s=this.length-1;s>=0;s--)this.updateRowIndex(s,n.get(s),e.get(s),r.get(s),i.get(s),t.get(s))}clone(t){let e=new o({client:t??this.client,user:this.user});return e.fromBuffer(this.toBuffer()),e.indexRowsOptimized(),e.getIdFromObject=this.getIdFromObject,e}createUniqueKeyFromRow(t){return`${t.client}/${t.seq}/${t.id}/${t.key}`}merge(t){return this.mergeRows(t.getRows())}mergeRows(t){f(this.transactionSeq===void 0,"You cannot add rows during a transaction");let e=new Set(this.getRows().map(i=>this.createUniqueKeyFromRow(i))),r=1/0,n=!1;for(let i of t){i.key==="parentid"&&(n=!0);let s=this.createUniqueKeyFromRow(i);e.has(s)||(e.add(s),this.addRowData(i.id,i.key,i.value,i.client,i.seq,i.user),r=Math.min(r,i.seq))}return this.resolved.clear(),this.arraySortedIndicesCache.clear(),n&&this.fixHierarchy(r),r}addRows(t){f(this.transactionSeq===void 0,"You cannot add rows during a transaction");let e=1/0,r=!1;for(let n of t)n.key==="parentid"&&(r=!0),this.addRowData(n.id,n.key,n.value,n.client,n.seq,n.user),e=Math.min(e,n.seq);return this.resolved.clear(),this.arraySortedIndicesCache.clear(),r&&this.fixHierarchy(e),e}transaction(t){f(this.transactionSeq===void 0,"You cannot nest transactions"),this.transactionSeq=this._seq;let e=t();return this.transactionSeq=void 0,e}updateKeyValue(t,e,r){let n=this.transactionSeq??this._seq;this.addRowData(t,e,r,this.client,n,this.user)}addRowData(t,e,r,n,i,s){let a=this.table.columns.client.length;if(!this.shouldAddRow(t,e,r,i,n))return;let d=this.table.columns;d.client.add(n),d.seq.add(i),d.id.add(t),d.key.add(e),d.value.add(r),d.user.add(s),this.updateRowIndex(a,i,t,e,r,n)}shouldAddRow(t,e,r,n,i){let s=this.latest.get(t,e);if(s===void 0)return!0;let a=this.table.columns;if(a.value.get(s)!==r)return!0;let c=a.seq.get(s),u=a.client.get(s);return!(c===n&&u===i)}updateRowIndex(t,e,r,n,i,s){e>=this._seq&&(this._seq=e+1);let a=this.latest.get(r,n),d=this.table.columns;if((a===void 0||Pr(e,s,d.seq.get(a),d.client.get(a)))&&this.latest.set(r,n,t),this.resolved.delete(r),this.arraySortedIndicesCache.delete(r),n==="parentid"){let c=this.parentIdHistoryByNodeId.get(r);c||(c=[],this.parentIdHistoryByNodeId.set(r,c)),c.push(t)}this.minIndexCache.add(e,t)}getPrevParentId(t,e,r){let n,i=this.parentIdHistoryByNodeId.get(t);if(!i?.length)return n;let s=this.table.columns;for(let a of i){let d=s.seq.get(a);if(d>e||!r&&d===e)continue;let c=s.client.get(a);(!n||d>n.seq||d===n.seq&&c>n.client)&&(n={seq:d,client:c,value:s.value.get(a)})}return n}isAncestorOf(t,e,r,n=new Set){if(t===e)return!0;if(!t||t==="$deleted"||n.has(t))return!1;n.add(t);let i=this.getPrevParentId(t,r,!0);if(!i)return!1;let s=this.parentIdOverrides.get(t)?.get(i.seq)??i.value;return this.isAncestorOf(s,e,r,n)}fixHierarchy(t=0){this.parentIdHistoryByNodeId=new Map([...this.parentIdHistoryByNodeId.entries()].sort((r,n)=>r[0].localeCompare(n[0])));for(let[r,n]of this.parentIdOverrides)for(let[i,s]of n)i>=t&&n.delete(i);let e=this.table.columns;for(let[r,n]of this.parentIdHistoryByNodeId)for(let i of n){let s=e.seq.get(i);if(s<t)continue;let a=e.value.get(i);if(this.isAncestorOf(a,r,s)){let d=this.parentIdOverrides.get(r);d||(d=new Map,this.parentIdOverrides.set(r,d));let c=this.getPrevParentId(r,s,!1);d.set(s,c?c.value:w)}}}getParentId(t){let e=this.latest.get(t,"parentid");if(!e)return;let r=this.table.columns.seq.get(e);return this.parentIdOverrides.get(t)?.get(r)??this.table.columns.value.get(e)}getChildrenIds(t){let e=this.getCurrentValue(t,"children");if(!e)return;let r=ut(e);if(!r)return;let n=this.getArray(r,!1);if(!Array.isArray(n))return;let i=new Set;for(let a of n){let d=ve(a);d&&this.getParentId(d)===t&&i.add(d)}let s=Array.from(this.parentIdOverrides.keys()).sort((a,d)=>a.localeCompare(d));for(let a of s)i.has(a)||this.getParentId(a)===t&&i.add(a);return Array.from(i)}_getIdFromObject(t){return this.getIdFromObject?.(t)}createReferenceId(t,e,r,n,i){if(e===0)return`${r}.${n}`;if(e===1)return`${r}.${i??lt(t)}`;Te(e)}getOrCreateReferenceFromValue(t,e,r,n){if(Array.isArray(t)){let i=this.createReferenceId(t,e,r,n,void 0);return this.setArray(i,t),nr(i)}if(Se(t)){let i=typeof t.id=="string"?t.id:void 0,s=this._getIdFromObject(t)??this.createReferenceId(t,e,r,n,i);return this.setObject(s,t),K(s)}return t}getReferenceValue(t,e,r,n){let i=ut(t);if(i)return this.getArray(i,!0,r,n);let s=ve(t);return s?this.getObjectInner(s,!0,e,r,n):t}getCurrentValue(t,e){let r=this.latest.get(t,e);if(r!==void 0)return this.table.columns.value.get(r)}getCurrentSeq(t,e){let r=this.latest.get(t,e);if(r!==void 0)return this.table.columns.seq.get(r)}validateObjectUpdate(t,e){if(!Se(e))throw new Error("Store.setObject: object is not an object");let r=this._getIdFromObject(e);if(r&&r!==t)throw new Error(`Store.getIdFromObject mismatch: ${r} !== ${t}: The id that we got to update the object is not equal to the result of getIdFromObject. See Store.update.test.ts`);return t}deleteRemovedKeys(t,e){let r=this.latest.getSubMap(t);if(r)for(let[n]of r)n!==q&&(n in e||this.setObjectKey(t,n,w))}tryReuseExistingReference(t,e){let r=ut(t);if(Array.isArray(e)&&r)return this.setArray(r,e),!0;let n=ve(t);return Se(e)&&n?(this.setObject(n,e),!0):!1}setObject(t,e){let r=this.validateObjectUpdate(t,e);if(this.deleteRemovedKeys(r,e),Object.keys(e).length===0){this.setObjectKey(r,q,qe);return}for(let n in e)this.setObjectKey(r,n,e[n])}setObjectKey(t,e,r){let n=this.getCurrentValue(t,e);if(this.tryReuseExistingReference(n,r))return n;let i=this.getOrCreateReferenceFromValue(r,0,t,e);return n===i||this.updateKeyValue(t,e,i),n}deleteObjectKey(t,e){this.getCurrentValue(t,e)!==void 0&&this.updateKeyValue(t,e,w)}setObjectKeyPath(t,e,r){if(!e[0])return;let n=t;for(let s=0;s<e.length-1;++s){let a=e[s],d=this.getRawObjectData(n);if(!d)throw new Error("Object not found");let c=d[a];c||(this.setObjectKey(n,a,{}),c=this.getCurrentValue(n,a));let u=ve(c);if(!u){let h=e.slice(0,s+1);throw new Error(`${h} is not an object`)}n=u}let i=e[e.length-1];this.setObjectKey(n,i,r)}getObjectKey(t,e){if(this.getCurrentValue(t,q)!==w)return this.getReferenceValue(this.getCurrentValue(t,e),!0,1/0,0)}getRawObjectData(t){return this.getObjectInner(t,!1,!0)}getObject(t){return this.getObjectInner(t,!0,!0)}getObjectWithShallowChildren(t,e){return this.getObjectInner(t,!0,!0,e,0)}getObjectInner(t,e,r,n=1/0,i=0){this.readTransactionLevel++;let s=()=>{this.readTransactionLevel--,this.foundIds.delete(t)};if(this.foundIds.has(t)){s();return}if(this.foundIds.add(t),!r&&this.resolved.has(t))return s(),this.resolved.get(t);let a=this.latest.getSubMap(t);if(!a){s();return}let d={};r||this.resolved.set(t,d);let c=this.table.columns;if(this.getCurrentValue(t,q)===w){s();return}let u=a.get("children");u!==void 0&&i<n&&(d.children=e?this.getChildrenIds(t)?.map(h=>this.getReferenceValue(K(h),r,n,i+1)):c.value.get(u)),a.has("parentid")&&(d.parentid=this.getParentId(t));for(let[h,m]of a){if(h===q||m===void 0)continue;let p=c.value.get(m);p!==w&&(h==="children"||h==="parentid"||(d[h]=e?this.getReferenceValue(p,r,n,i+1):p))}return s(),this.readTransactionLevel===0&&this.foundIds.clear(),d}applyArrayEdits(t,e){let r=0;for(let n of e)switch(n.operation){case"delete":this.arrayRemove(t,n.index+r,1),r--;break;case"insert":this.arrayInsert(t,n.index,n.value),r++;break}}setArray(t,e){let r=this.getArray(t,!1);r||(this.updateKeyValue(t,-1,qe),r=[]);let n=e.map(s=>this.getOrCreateReferenceFromValue(s,1,t,void 0)),i=at(r,n);this.applyArrayEdits(t,i)}getArraySortedIndicesCached(t){let e=this.arraySortedIndicesCache.get(t);if(e)return e;let r=this.latest.getSubMap(t);if(!r)return[];let n=this.table.columns,s=Array.from(r.values()).sort((a,d)=>n.key.get(a)-n.key.get(d)).filter(a=>{let d=n.value.get(a);return d!==w&&d!==qe});return this.arraySortedIndicesCache.set(t,s),s}getArray(t,e=!0,r=1/0,n=0){if(!this.latest.getSubMap(t))return;let s=this.getArraySortedIndicesCached(t),a=this.table.columns,d=[];for(let c of s){let u=a.value.get(c);u===qe||u===w||d.push(e?this.getReferenceValue(u,!0,r,n+1):u)}return d}arrayReplace(t,e,r){return this.arraySplice(t,e,1,r)}arraySplice(t,e,r,...n){if(!this.latest.getSubMap(t))return;let s=this.getArraySortedIndicesCached(t),a=s.length,d=e<0?Math.max(a+e,0):Math.min(e,a),c=r===void 0?a-d:Math.min(r,a-d),u=this.table.columns,h=[];for(let F of s.slice(d,d+c))h.push(u.value.get(F)),this.updateKeyValue(t,u.key.get(F),w);let m=d>0?s[d-1]:void 0,p=m!==void 0?u.key.get(m):0,g=s[d],y=g!==void 0?u.key.get(g):p+1,B=p,x=m!==void 0?u.client.get(m):null,k=m!==void 0?u.seq.get(m):null;for(let F of n){let _=x===this.client&&k!==null?k+1:1,C=dt(B,y,this.client,x,k,_);this.updateKeyValue(t,C,this.getOrCreateReferenceFromValue(F,1,t,void 0)),B=C,x=this.client,k=_}return h}arrayInsert(t,e,...r){return this.arraySplice(t,e,0,...r)}arrayRemove(t,e,r=1){return this.arraySplice(t,e,r)}get length(){return this.table.columns.client.length}compact(){let t=new o({client:this.client,user:this.user});t.getIdFromObject=this.getIdFromObject;let e=new Set,r=this.table.columns;for(let n=0;n<this.length;n++)e.add(r.id.get(n));for(let n of e){let i=this.latest.getSubMap(n);if(i)for(let[s,a]of i){if(a===void 0)continue;let d=r.value.get(a),c=r.client.get(a),u=r.seq.get(a),h=r.user.get(a);d!==w&&t.addRowData(n,s,d,c,u,h)}}return t}};var Or=2**52;function Fr(){return Math.floor(Math.random()*Or)}var Mr=Fr;function ir(o){let t=Mr(),e=new J({client:t,user:o});return e.getIdFromObject=r=>r.__class&&le(r.__class)?r.id:void 0,e}var j=b("tree:timeline"),Vr=6e4,qr=6e4,ht=class{constructor(t){this.nodeChangesBuffers=t;l(this,"changes",new Map);this.nodeChangesBuffers.add(this)}trackChange(t,e){let r=this.changes.get(t);if(r){e&&r.push(e);return}this.changes.set(t,e?[e]:[])}read(){let t=this.changes;return this.changes=new Map,t}clear(){this.changes=new Map}dispose(){this.nodeChangesBuffers.delete(this)}},je=class{constructor(t,e,r=[],n=!1){this.tree=t;this.changes=e;this.editReasons=r;this.wasRebase=n;l(this,"wasScopeInsert",!1);l(this,"version",0);l(this,"timestamp",performance.now())}toDebugData(){return{version:this.version,changes:this.changes,editReasons:this.editReasons,wasScopeInsert:this.wasScopeInsert,wasRebase:this.wasRebase}}},Be=class{constructor(){l(this,"idToChanges",new Map)}getChanges(){return Array.from(this.idToChanges.values())}addChanges(t){if(t)for(let e of t){let r=this.idToChanges.get(e.id);r||(r={id:e.id,to:{}},this.idToChanges.set(e.id,r)),Ze(r,e)}}},sr=class{constructor(t,e){l(this,"tree");l(this,"entries");l(this,"latestReversibleNodeChanges",null);l(this,"enableAddRemoveOptimizations",!0);l(this,"store");l(this,"trimmed",0);l(this,"isPartialLoading",!1);l(this,"internalRemoteTreeIndex",0);l(this,"inErrorRecovery",!1);l(this,"nodeChangesBuffers",new Set);l(this,"legacyMode",!1);l(this,"remoteTreeVersion",0);l(this,"recentEditReasons",[]);l(this,"flagsForNextCommit");l(this,"onlineStartTime",0);l(this,"validationEnabled",z.isOn("remoteDocumentSyncValidation")&&!0&&!ue());l(this,"extraChangesForNextCommit");l(this,"resetTime",0);l(this,"epoch",0);this.store=ir(""),this.reset(t,e)}get length(){return this.entries.length+this.trimmed}get localTreeIndex(){return this.length-1}get remoteTreeIndex(){return this.internalRemoteTreeIndex}incrementRemoteTreeIndex(t){this.internalRemoteTreeIndex+=t}setOnline(t){this.online!==t&&(this.onlineStartTime=t?performance.now():0)}get online(){return this.onlineStartTime!==0}setFlagsForNextCommit(t){this.flagsForNextCommit=t}validateUpdatesAreSentToServer(){if(!this.validationEnabled||!this.online)return;let t=performance.now();if(t-this.onlineStartTime<qr)return;let r=this.getOldestLocalEntry();if(!r)return;let n=t-r.timestamp;f(n<Vr,"Local changes not been processed in a while")}setExtraChangesForNextCommit(t){this.extraChangesForNextCommit=t}recordEditReasons(t){t&&this.recentEditReasons.push(t)}trackChange(t,e=null){for(let r of this.nodeChangesBuffers)r.trackChange(t,e)}getTreeForVersion(t){if(!this.isPartialLoading)return Dt(this.entries,e=>e.version===t)?.tree}addEntry(t,e,r=[],n=!1){let i=new je(t,e,r,n);return this.entries.push(i),this.tree=t,i}getLastEntry(){let t=this.entries[this.entries.length-1];return f(t,"Timeline has no entries"),t}getOldestLocalEntry(){return this.getEntry(this.remoteTreeIndex+1)}getEntry(t){return this.entries[t]}reset(t,e){if(this.resetTime=performance.now(),this.inErrorRecovery&&t===this.tree){j.debug("reset for error recovery..."),this.inErrorRecovery=!1,this.invalidateAllCursors(),this.clearNodeChangesReader();return}j.debug("reset with tree:",t.root.id,"size:",t.size()),this.entries=[],this.addEntry(t,e?.initialChanges??[],["load"]),this.recentEditReasons=[],this.flagsForNextCommit=void 0,this.extraChangesForNextCommit=void 0,this.latestReversibleNodeChanges=null,this.trimmed=0,this.internalRemoteTreeIndex=0,this.isPartialLoading=!!e?.isLoading,this.invalidateAllCursors(),this.clearNodeChangesReader()}invalidateAllCursors(){this.epoch+=1}openNodeChangesReader(){return new ht(this.nodeChangesBuffers)}clearNodeChangesReader(){for(let t of this.nodeChangesBuffers)t.clear()}applyFlagsToChange(t){t&&this.flagsForNextCommit&&(this.flagsForNextCommit.ignoreInUndo&&(t.ignoreInUndo=!0),this.flagsForNextCommit.ignoreInCodeGeneration&&(t.ignoreInCodeGeneration=!0))}commitLocalTree(){this.validateUpdatesAreSentToServer();let t=this.getLastEntry();f(this.tree===t.tree,"tree out of sync");let e={};this.tree=this.tree.commit((n,i)=>{if(!n&&!i)return;let s=Ne(n,i);if(this.applyFlagsToChange(s),this.trackChange(n?.id??i.id,s),s){if(s.to.parentid&&s.to.parentid!==s.from?.parentid){let d=this.tree.getScopeNodeAtStartFor(n),c=this.tree.getScopeNodeFor(i);d&&d?.id!==c?.id&&(s.previousScope=d.id)}e[s.id]=s}let a=[];Ft(a,n,i);for(let d of a)this.applyFlagsToChange(d),this.trackChange(d.id,d),e[d.id]=d}),this.latestReversibleNodeChanges=Object.values(e);let r=this.latestReversibleNodeChanges;if(this.extraChangesForNextCommit){r=[...r];for(let n of this.extraChangesForNextCommit)this.applyFlagsToChange(n),this.trackChange(n.id,n),r.push(n)}if(this.flagsForNextCommit=void 0,this.extraChangesForNextCommit=void 0,j.debug("commit local tree:",r.length,this.recentEditReasons),r.length>0){if(ue())for(let n of r)this.updateStoreFromChanges(n);f(t.tree!==this.tree,"must be a new tree"),t.tree.releaseMemory(),this.entries.push(new je(this.tree,r,this.recentEditReasons))}else this.tree!==t.tree&&(t.tree.releaseMemory(),t.tree=this.tree);return this.recentEditReasons=[],f(this.tree===this.getLastEntry().tree),this.tree}updateStoreFromChanges(t){this.store.transaction(()=>{let{_deleted:e,...r}=t.to;if(Pt(t.id)){let[n,i]=At(t.id);if(t.removed){this.store.setObjectKey(t.id,"parentid",w);return}let s=r;if(e)for(let a of e)s[a]=w;for(let a in s)this.store.setObjectKeyPath(n,["replicaInfo","overrides",i,a],s[a]);if(t.toChildren){let a=t.toChildren.map(d=>K(d));this.store.setObjectKey(t.id,"children",a);for(let d of t.toChildren)this.store.setObjectKey(d,"parentid",t.id)}}else{if(t.added){let s={...t.to,id:t.id,__class:t.added};t.toChildren&&(s.children=t.toChildren.map(a=>K(a))),this.store.setObject(t.id,s);return}if(t.removed){this.store.setObjectKey(t.id,"parentid",w);return}for(let s in t.to)this.store.setObjectKey(t.id,s,r[s]);let n=t.added||"__class"in r,i="id"in r;if(n&&!i&&this.store.setObjectKey(t.id,"id",t.id),e)for(let s of e)this.store.setObjectKey(t.id,s,void 0);if(t.toChildren){let s=t.toChildren.map(a=>K(a));this.store.setObjectKey(t.id,"children",s)}}})}getLatestChangesForUndo(){return this.latestReversibleNodeChanges}getChangeTrackingCursor(){let t=this.remoteTreeIndex,e=this.localTreeIndex;return{remoteTree:t,localTree:e,timeline:this,tree:this.tree,epoch:this.epoch}}invalidatedByLoadCompletedDocument(t){return!(!t||this.trimmed>0||t.timeline!==this||t.epoch+1!==this.epoch||t.remoteTree+1!==this.remoteTreeIndex)}fetchForwardChanges(t){if(!t||t.epoch!==this.epoch||t.tree.lineage!==this.tree.lineage||t.tree.root.id!==this.tree.root.id||t.timeline!==this||t.localTree>0&&t.localTree<=this.trimmed||t.remoteTree>0&&t.remoteTree<=this.trimmed||this.remoteTreeIndex>0&&this.trimmed>0&&t.remoteTree===0)return;let e=t.localTree;if(this.remoteTreeIndex>0)for(e=t.remoteTree-1;e<t.localTree&&!this.entries[e+1-this.trimmed]?.wasRebase;)e+=1;f(e-this.trimmed>=0,"buffer cut too close to remoteTree"),f(e<=t.localTree,"startIndex incorrectly calculated");let r=this.localTreeIndex;f(e<=r,"bad change tracking cursor");let n=t.tree;return t.remoteTree=this.remoteTreeIndex,t.localTree=r,t.tree=this.tree,this.computeForwardChanges(e,r,n)}computeForwardChanges(t,e,r){if(t>=e)return[];let n={};for(let s=t+1;s<=e;s++){let a=this.entries[s-this.trimmed];for(let d of a.changes){let c=d.id,u=n[c];u||(u=n[c]={id:c,to:{}});let h=u.added;Ze(u,d),!r&&h&&u.removed&&this.enableAddRemoveOptimizations&&delete n[c]}}let i=r??this.entries[t-this.trimmed]?.tree;if(!i)throw new Error(`${t} - ${this.trimmed}`);return Object.values(n).filter(s=>{if(s.removed)return s.to={},!0;let a=i.getNodeAtStart(s.id);if(a&&this.enableAddRemoveOptimizations)for(let[h,m]of Object.entries(s.to))de(a[h],m)&&delete s.to[h];if(s.added||Object.keys(s.to).length>0)return!0;let d=s.toChildren;if(!d)return!1;if(!a)return!0;i.beginAllowPartialScopeAccess();let c=a.children;if(i.endAllowPartialScopeAccess(),!c||!this.enableAddRemoveOptimizations)return!0;let u=c.length;if(u!==d.length)return!0;for(let h=0;h<u;h++)if(c[h].id!==d[h])return!0;return!1})}getEditReasons(t,e){let r=[],n="";for(let i=t+1;i<=e;i++){let s=this.entries[i-this.trimmed].editReasons;for(let a of s)a&&n!==a&&(n=a,r.push(a))}return r.join(" ")}getChangesBetweenEntries(t,e){f(t<e,"inconsistency in getting local changes to send");let r=this.computeForwardChanges(t,e),n=this.getEditReasons(t,e);return{count:e-t,changes:r,reasons:n}}debugOverwriteCurrentTree(t){j.debug("recover with tree:",t.root.id),this.tree=t,this.getLastEntry().tree=t}resetTreesForRecovery(t,e){j.info("reset trees for recovery, remote:",this.remoteTreeIndex,"local:",this.localTreeIndex,"changes already sent:",e);let r=this.entries[t]?.tree;f(r,"unable to get remote tree");let n=r.getService("loader"),i=r.lineage.editHooks,s=[];try{r=Le(JSON.parse(JSON.stringify(r.toJS())),s)}catch(d){if(d instanceof RangeError&&d.message.includes("Invalid string length"))j.warn("[recovery] Tree too large for JSON serialization, using original tree",{error:d.message,treeSize:r.size()}),s.push("Recovery skipped: tree too large for serialization");else throw d}n&&(n.resetTreeForRecovery(r),f(r.getService("loader")===n,"tree must have the same loader")),i&&(r.lineage.editHooks=i),s.length>0&&j.warn("[recovery] encountered errors while reloading the tree:",s),this.entries[t].tree=r,this.entries.length=t+e+1;let a=r;for(let d=t+1;d<this.entries.length;d++){let c=this.entries[d];E(r,c.changes),r=r.commitDiffs(),c.tree=r,r!==a&&(a.releaseMemory(),a=r)}return this.inErrorRecovery=!0,this.tree=r,r}saveTimelineDataForRecovery(){if(window.localStorage)try{let t=`debugTimelineAtRecovery-${Math.floor(Math.random()*100)}`,e={date:new Date().toString(),entries:this.entries.map(r=>r.toDebugData())};window.localStorage.setItem(t,JSON.stringify(e))}catch(t){j.warn("failed to store timeline in localStorage:",t)}}};var or=class{constructor(){l(this,"undoBuffer",[]);l(this,"redoBuffer",[]);l(this,"undoGroup",[]);l(this,"scheduledEndUndoGroup")}canUndo(){return this.undoBuffer.length>0}peekUndo(){return this.undoBuffer.at(-1)}undo(t,e){let r=this.undoBuffer.pop();if(X(r))return;tt(t,r.changes),this.redoBuffer.push({...r,...e});let n=this.undoBuffer.length;return this.undoGroup.forEach((i,s)=>{this.undoGroup[s]=Math.min(i,n)}),r}canRedo(){return this.redoBuffer.length>0}peekRedo(){return this.redoBuffer.at(-1)}redo(t,e){let r=this.redoBuffer.pop();if(!X(r))return E(t,r.changes),this.undoBuffer.push({...r,...e}),r}beginUndoGroup(){this.undoGroup.push(this.undoBuffer.length)}discardUndoGroup(t){let e=this.undoGroup.pop();if(X(e)||e>=this.undoBuffer.length)return;let r=this.undoBuffer.splice(e),n=Qe(r);return tt(t,n),r[0]}scheduleEndUndoGroup(){let t=this.undoGroup.pop();X(t)||t>=this.undoBuffer.length||(this.scheduledEndUndoGroup=t)}processScheduledEndUndoGroup(t){let e=this.scheduledEndUndoGroup;if(this.scheduledEndUndoGroup=void 0,X(e)||e>=this.undoBuffer.length)return;let r=this.undoBuffer.splice(e),n=Qe(r);this.undoBuffer.push({changes:n,...t})}clearUndoStack(){this.undoBuffer.length=0,this.redoBuffer.length=0,this.undoGroup.length=0,this.scheduledEndUndoGroup=void 0}addUndoEntry(t){this.undoBuffer.push(t),this.redoBuffer.length=0}getUndoBufferSize(){return this.undoBuffer.length}};var T=Tr(Cr());var jr=0,_e=class{constructor(){l(this,"id",++jr);l(this,"currentRtt",NaN);l(this,"rtts",[]);l(this,"rttIndex",0);l(this,"pending",Array.from(Array(128),()=>({type:"",time:0})));l(this,"start",0);l(this,"end",0);l(this,"overflow",0);l(this,"lastSendTime",0);l(this,"bytesSent",0);l(this,"bytesReceived",0)}read(){let{bytesSent:t,bytesReceived:e,id:r}=this;return this.bytesSent=0,this.bytesReceived=0,[t,e,this.rtt(),r]}computeRtt(){let t=this.rtts.length;if(t===0){this.currentRtt=NaN;return}let e=0;for(let r of this.rtts)e+=r;this.currentRtt=e/t}lastSend(){return this.lastSendTime}rtt(){return Number.isNaN(this.currentRtt)&&this.computeRtt(),Math.max(this.currentRtt||0,this.pendingRtt())}pendingRtt(){return this.start===this.end?0:performance.now()-this.pending[this.start].time}pendingCount(t){if(!t)return this.start>this.end?128-this.start+this.end:this.end-this.start;let e=0;for(let r=this.start;r!==this.end;r=r+1&127)this.pending[r].type===t&&e++;return e}sent(t,e){this.bytesSent+=e.length,this.end===(this.start===0?127:this.start-1)&&(this.start=this.start+1&127,this.overflow++);let r=this.pending[this.end];r.type=t,r.time=performance.now(),this.end=this.end+1&127,this.lastSendTime=r.time}received(t){this.bytesReceived+=t.length}acked(){if(this.start===this.end){console.warn("Called SocketStats.acked() with empty buffer");return}if(this.overflow>0){this.overflow--;return}let t=this.pending[this.start],e=performance.now()-t.time;this.rtts.length<32?this.rtts.push(e):(this.rtts[this.rttIndex]=e,this.rttIndex=this.rttIndex+1&31),this.start=this.start+1&127,this.currentRtt=NaN}};var O=b("remote:socket"),Br=28;function _r(o){switch(o){case"AccessDenied":case"ClientNeedsUpdate":case"ClientTooNew":case"DocumentNotFound":case"UnsupportedSchema":case"Maintenance":case"UnknownPermanentError":case"ClientSidePermanentError":return!1;case"ReconnectToNewServer":case"UnknownRecoverableError":case"ClientSideRecoverableError":return!0;default:return Te(o)}}function Es({url:o,documentConnection:t,tunnel:e=null}){let r=(0,T.useRef)(null),n=(0,T.useRef)(!0),i=(0,T.useRef)({onConnect:new Set,onDisconnect:new Set,onMessage:new Set}),s=(0,T.useRef)(o),a=(0,T.useRef)(!0),d=(0,T.useRef)(void 0);function c(){d.current!==void 0&&(window.clearTimeout(d.current),d.current=void 0)}let u=(0,T.useCallback)(()=>{a.current=!1;let g=r.current;g&&g.ws.readyState<WebSocket.CLOSING&&(g.clientClosed=!0,g.ws.close())},[]),h=(0,T.useCallback)(()=>{if(c(),!a.current||r.current)return;function g(C){d.current===void 0&&(d.current=window.setTimeout(()=>{d.current=void 0,navigator.onLine&&!document.hidden&&h()},C))}let y=new URL(s.current);if(y.searchParams.set("v",Br.toString()),y.searchParams.set("tunnel",e||""),ue()&&y.searchParams.set("mode","crdt"),t.treeSchema<=0)return;y.searchParams.set("treeSchema",t.treeSchema.toString()),y.searchParams.set("treeVersion",t.treeVersion.toString()),O.debug("connecting to",y.href);let B=performance.now(),x=new WebSocket(y.href),k=new _e,F={ws:x,stats:k,clientClosed:!1};t.setSocketStats(k);let _=0;x.addEventListener("open",()=>{O.debug("open"),_=window.setInterval(()=>{if(performance.now()-k.lastSend()<1e3||k.pendingCount("ping")>1||x.readyState!==WebSocket.OPEN)return;let C="ping {}";x.send(C),k.sent("ping",C)},1e3);for(let C of i.current.onConnect)try{C(n.current)}catch(D){O.warn("Error in onConnect handler:",D)}n.current=!1}),x.addEventListener("close",C=>{let D=Hr(C);if(O.debug("close:",D,"clientClosed:",F.clientClosed,C),_!==0&&(clearInterval(_),_=0),r.current===F){_r(D)||(a.current=!1);for(let U of i.current.onDisconnect)try{U(D)}catch(Ge){O.warn("Error in onDisconnect handler:",Ge)}if(r.current=null,a.current){let U=1e3;D==="ReconnectToNewServer"?U=50:performance.now()-B<5e3&&(U=5e3),g(U)}}}),x.addEventListener("message",C=>{try{let D=C.data;k.received(D);let U=Wr(D);if(U.type==="ack"){k.acked();return}else U.type==="redirect"&&(s.current=U.value.url);for(let Ge of i.current.onMessage)try{Ge(U)}catch(wr){O.warn("Error in onMessage handler:",wr)}}catch(D){O.warn("Error receiving:",D)}}),r.current=F},[t]);(0,T.useEffect)(()=>{h()},[h]);let m=(0,T.useCallback)(({online:g,visible:y})=>{g&&y?h():c()},[h]);return zr(m),(0,T.useMemo)(()=>({getSocketStats(){return r.current?.stats},connect(){a.current=!0,h()},disconnect(){u()},onConnect(g){return i.current.onConnect.add(g),()=>{i.current.onConnect.delete(g)}},onDisconnect(g){return i.current.onDisconnect.add(g),()=>{i.current.onDisconnect.delete(g)}},onMessage(g){return i.current.onMessage.add(g),()=>{i.current.onMessage.delete(g)}},send(g){if(!r.current||r.current.ws.readyState!==1){g.type!=="state"&&O.warn("Dropping",g.type,"message.");return}try{let y=`${g.type} ${JSON.stringify(g.value)}`;r.current.ws.send(y),r.current.stats.sent(g.type,y)}catch(y){O.warn("Error sending",g.type,"message:",y)}}}),[h,u])}function zr(o){(0,T.useEffect)(()=>{document.addEventListener("visibilitychange",t),window.addEventListener("online",t),window.addEventListener("offline",t);function t(){o({online:navigator.onLine,visible:!document.hidden})}return()=>{document.removeEventListener("visibilitychange",t),window.removeEventListener("online",t),window.removeEventListener("offline",t)}},[o])}function Hr(o){switch(o.reason){case"ERR_RECONNECT_TO_NEW_SERVER":return"ReconnectToNewServer";case"ERR_ACCESS_DENIED":return"AccessDenied";case"ERR_CLIENT_NEEDS_UPDATE":return"ClientNeedsUpdate";case"ERR_DOCUMENT_NOT_FOUND":return"DocumentNotFound";case"ERR_UNSUPPORTED_SCHEMA_VERSION":return"UnsupportedSchema";case"ERR_MAINTENANCE":return"Maintenance";case"ERR_INVALID_OPERATION":return"ClientSidePermanentError";case"ERR_UNKNOWN":return"UnknownPermanentError"}return o.code===1011?"ClientNeedsUpdate":"UnknownRecoverableError"}function Wr(o){let t=o.indexOf(" "),e=o.indexOf(" ",t+1);f(t>=0&&e>=0,"Invalid data");let r=o.substring(0,t),n=o.substring(t+1,e),i=o.substring(e+1),s=JSON.parse(i);return{id:r,type:n,value:s}}function ze(o){return typeof o=="object"&&!Array.isArray(o)&&o!==null}function ar(o,t){if(!ze(o)&&ze(t))return Object.assign({},t);if(!ze(o)||!ze(t))return t;for(let e of Object.keys(t))o[e]=ar(o[e],t[e]);return o}function ft(o,...t){let e=o;for(let r of t)e=ar(e,r);return e}function dr(o){return o===void 0}function $r(o,t,e){let r=e.replicaInfo;if(r?.master){let s=o.get(r.master);if(!s||!Z(s))return!0}if(r?.inheritsFrom){let s=o.get(r.inheritsFrom);if(!s||!(ce(s)||Z(s)))return!0}let n=e.parentid;if(!n)return!1;let i=o.get(n);return i?o.isAncestorOfNode(i,t):!0}function Kr(o,t,{children:e,...r}){if(f(!o.has(t),"Tree must not have node",t),!r.parentid)return null;let n=o.get(r.parentid);if(!n||xt(n)&&!n.isLoaded())return null;let i=r.__class;if(!i)throw new Error("Unknown node class for: "+t);let s=le(i);if(!s)throw new Error("Unknown node class for: "+t);let a=r.replicaInfo;if(a){let c=o.get(a.master);if(!c||!Z(c))throw Error("broken diff, replica without master: "+t+" "+a.master);let u=Ut(a),h=Ee.create(o,c,{overrides:u?.overrides,owner:t,inheritsFrom:u?.inheritsFrom,duplicatedFrom:r.duplicatedFrom,fromDiff:!0});return h.parentid=r.parentid,o.insertNode(h,h.parentid),h}if(Lt(s)){f(kt(t),"Invalid EntityReferenceNode ID: "+t);let c=new s({...Xe(r),id:t});return o.insertNode(c,c.parentid),c}let d=new s({...Xe(r),id:t});return o.insertNode(d,d.parentid),d}function Jr(o,t){o.has(t)&&o.remove(t)}function Gr(o,t,{children:e,...r}){let n=o.get(t);if(!n)return null;if(r.parentid&&n.parentid!==r.parentid){if(!o.has(r.parentid))return o.remove(t),null;o.move(t,r.parentid)}let i=n.asDraft(o);for(let s in r){let a=i[s];s==="replicaInfo"||typeof a!="object"||Array.isArray(a)||a===null||(r[s]=ft({},a,r[s]))}if(r.replicaInfo&&ce(n)){let{overrides:s,_deleted:a,...d}=r.replicaInfo;for(let u in s){let h=s[u],m=i.replicaInfo?.overrides[u];m!==null&&typeof m=="object"&&!Array.isArray(m)&&(h=ft({},m,h)),h&&Ot(o,i,u,h)}let c=Object.assign(i.replicaInfo,d);return Q.updateNode(o,i,r),i.replicaInfo=c,i.cache.rebuildReplica=!0,i}else return Q.updateNode(o,n,r),i}function Yr(o,t){if(o.length!==t.length)return!1;for(let e=0;e<o.length;e++)if(o[e].id!==t[e])return!1;return!0}function Xr(o,t,e){if(Yr(t.children,e))return;let r=[];for(let s=0,a=e.length;s<a;s++){let d=o.get(e[s]);d&&d.parentid===t.id&&r.push(d)}let n=new Set(e),i=t.children;for(let s=0,a=i.length;s<a;s++){let d=i[s];n.has(d.id)||r.push(d)}Tt(i,r)||(t.asDraft(o).children=r)}function cr(o,t){o.applyingDiffs=!0;let e=Array.from(t.keys()),r=[...e];for(;r.length>0;){let n=[];for(let i of r){let s=t.get(i);dr(s)||($r(o,i,s)?n.push(i):o.has(i)?Gr(o,i,s):s.__class&&Kr(o,i,s))}if(n.length===0||n.length===r.length)break;r=n}for(let n of e){let s=t.get(n)?.children;if(!s||s.length===0)continue;let a=o.get(n);if(a){if(!a.children)throw Error("assertion failure: node has no children");Xr(o,a,s)}}for(let n of e){let i=t.get(n);dr(i)&&Jr(o,n)}return o.applyingDiffs=!1,o.commitDiffs()}function pt(o,t){let e=o.getParentId(t);for(;e&&e!==w;)e=o.getParentId(e);return e===w}function Zr(o,t,e){let r=new Map;for(let[n,i]of t){if(pt(o,n)){r.set(n,void 0);continue}let s=o.getObject(n);if(!s.__class||!le(s.__class))continue;let a={id:n,parentid:o.getParentId(n),children:o.getChildrenIds(n)??[]},d=e.has(n)?Object.keys(s).map(c=>[c]):i;for(let c of d){let u=a,h=s;for(let[m,p]of c.entries()){if(p==="parentid"||p==="children"||p===q)break;if(Array.isArray(u)){!u.length&&Array.isArray(h)&&u.push(...h);break}if(!(p in u))if(h?.[p]===void 0)u?._deleted||(u._deleted=[]),u._deleted.push(p);else if(m===c.length-1)u[p]=h[p];else{let y=Array.isArray(h[p]);u[p]=y?[]:{}}u=u[p],h=h[p]}}r.set(n,a),a.parentid&&(r.has(a.parentid)||r.set(a.parentid,{children:o.getChildrenIds(a.parentid)}))}return r}function lr(o,t=0){let e=new Map,r=o.table.columns,n=o.getFirstRowForSeq(t);for(let i=n;i<r.client.length;++i){if(r.seq.get(i)<t)continue;let a=r.id.get(i),d=r.key.get(i),c=a.split("."),[u,...h]=c,m=e.get(u);m||(m=[],e.set(u,m)),h.push(d),m.push(h)}return e}function Qr(o,t){let e=lr(t),r=new Set;for(let[n,i]of e){let s=t.getCurrentSeq(n,"parentid");if(s===void 0||t.getCurrentValue(n,"parentid")===w)continue;let d=o.getCurrentSeq(n,"parentid");d!==void 0&&(d>s||pt(o,n)&&r.add(n))}return r}function en(o,t){let e=[...t];for(let r of e)for(let n of o.getChildrenIds(r)??[])e.push(n);return new Set(e)}function ur(o,t){let e=t.getRows();if(!e.length)return new Map;let r=Qr(o,t),n=o.addRows(e);for(let s of Array.from(r))pt(o,s)&&r.delete(s);r=en(o,r);let i=lr(o,n);for(let s of r)i.has(s)||i.set(s,[]);return Zr(o,i,r)}var mt=class{constructor(t,e){this.id=t;this.store=e;l(this,"loadedScope")}loadScopeDataFromStore(){let t=this.store.getObject(this.id);if(!t){N.debug("No object with id "+this.id+" in the store");return}return t}createNodeFromData(t){let e=this.buildPage(t);if(e)return e.cache.isShallowLoad=!1,e}async run(t){if(this.loadedScope)return this.loadedScope;let e=performance.now(),r=this.loadScopeDataFromStore(),n=performance.now()-e;if(await t.yield(),this.loadedScope)return this.loadedScope;let i=performance.now(),s=this.createNodeFromData(r),a=performance.now()-i;return this.loadedScope=new $(s,n+a),this.loadedScope}force(){if(this.loadedScope)return this.loadedScope;let t=performance.now(),e=this.loadScopeDataFromStore(),r=this.createNodeFromData(e),n=performance.now()-t;return this.loadedScope=new $(r,n),this.loadedScope}buildPage(t){if(!t)return;let e=[],r=N.isLoggingTraceMessages()?[]:void 0,n=M(t,void 0,{extraChecksAndFixes:!0,errors:e,warnings:r});if(n&&Ue(n,e),e.length>0&&N.warn("errors loading server tree: "+e.join(`
`)),r&&r.length>0&&N.trace("warnings loading server tree: "+r.join(`
`)),!!n)return n}},N=b("CrdtDocumentLoader"),we=class extends W{constructor(e,...r){super(...r);this.store=e;l(this,"parsedIds",new Set)}async loadFirstCrdtTree(e){let r=[],i=this.store.getObjectWithShallowChildren(e.rootId,2),s=i?.homePageNodeId,a=this.settings.activeNodeId,d=a?this.store.getObjectWithShallowChildren(a,2):void 0;if(d){for(;d.parentid!==e.rootId;){if(!d.parentid)throw Error("active node has no parent");d=this.store.getObjectWithShallowChildren(d.parentid,2)}s=d.id}let c=M(i,null,{extraChecksAndFixes:!0,errors:r,warnings:r});if(!c)throw Error("Unable to create load document");let u=[...$t,s];for(let p of u){if(!p)continue;let g=this.store.getObject(p);if(!g){N.debug("No value for "+p);continue}let y=M(g);y.cache.isShallowLoad=!1;let B=c.children.findIndex(x=>x.id===p);c.children[B]=y,this.parsedIds.add(p)}for(let p of c.children)this.parsedIds.has(p.id)||this.scopesToLoad.add(p.id);zt(c,r),c.children.forEach(p=>{if(!this.parsedIds.has(p.id)&&Array.isArray(p.children)&&ke(p)){p.cache.isShallowLoad=!0;return}});let h=Vt.createByAdoptingRoot(c);h.verify(),h=Ee.treeDidLoad(h,[]).didNonLinearMove(bt);let m=[];return _t(h,m)&&(m.forEach(p=>{r.push(`${p.id}: code component links itself via ${p.stack}`),Ht(h,p.id,p.stack)}),h=h.commit()),await this.emitWrapped(()=>{if(this.scheduler.isDone())return;let p=performance.now();h.setService("loader",this),this.emit("loadedFirstData",h),R("parsingFirstPage"),this.parsingDuration+=performance.now()-p}),h}async createTreeFromBuffer(e){this.documentSize=e.byteLength,this.store.fromBuffer(e);let r=this.store.getObject("meta");if(!r)throw new Error("Meta field not found");if(!St(r.version))throw Error("cannot read document version");for(this.canvasTreeVersion=r.version,N.debug("createTree",this.canvasTreeVersion,H(this.documentSize),I(this.loadingDuration)),this.emit("loadedDocumentVersion",r.version),this.tree=await this.loadFirstCrdtTree(r),this.loadedFirstScope=!0,this.updatePauseResumeState(),await this.scheduler.yield(),R("parsingResume");this.hasNextScopeToLoad();)await this.loadNextScopeAsync(),await this.scheduler.yield();await this.emitWrapped(()=>{f(this.tree,"tree must have been set"),this.tree.setService("loader",void 0),this.emit("loadedAllData")}),N.debug("done",H(this.documentSize),"loading:",I(this.loadingDuration),"parsing:",I(this.parsingDuration))}async start(){await this.scheduler.run(async()=>{N.debug("start"),R("parsingInit"),this.updatePauseResumeState();let e=performance.now(),r=await this.loadCrdtData();this.loadingDuration=performance.now()-e,await this.scheduler.yield(),await this.createTreeFromBuffer(r)})}async loadCrdtData(){let e=this.settings.initData,r=e?.version===this.treeVersion,n=e?.prefetchPromise;if(N.debug("loadData: prefetch"),r&&n){e&&delete e.prefetchPromise;let s=await n;if(n.then(a=>a.duration).then(a=>{R("dataLoad",a)}),await this.scheduler.yield(),s.status<200||s.status>=300)throw new Error(`Failed to fetch project data. Status code: ${s.status}`);if(s.buffer){N.debug("loadData: prefetch bytes parser");let a=await s.buffer;return await this.scheduler.yield(),new Uint8Array(a)}}N.debug("loadData: fetch");let i;this.settings.refreshAccessToken&&(i=await this.settings.refreshAccessToken({}),await this.scheduler.yield());for(let s=0;s<Oe;++s){let a=await fetch(this.documentURL,i);if(a.ok){await this.scheduler.yield();let d=await a.arrayBuffer();return await this.scheduler.yield(),new Uint8Array(d)}(a.status<200||a.status>=300)&&(N.debug("onErrorStatusLoaded, retry:",s),await this.scheduler.sleep(s*fe+Math.random()*fe))}throw Error(`Failed to fetch project data after attempting ${Oe} times`)}createLoadingScope(e){return new mt(e,this.store)}};function hr(o){if(!o.children)return;let t=new Map;for(let e of o.children)Z(e)&&t.set(e.id,{master:e,replicas:new Map});for(let e of o.children){if(!ce(e))continue;let r=t.get(e.replicaInfo.master);r&&r.replicas.set(e.id,e)}for(let{master:e,replicas:r}of t.values())tn(e,r)}function tn(o,t){for(let e of t.values()){let r=e.replicaInfo;f(r.master===o.id,"Replica must match master");let n=r.overrides;if(r.inheritsFrom){let h=t.get(r.inheritsFrom);h&&(n=Rt(n,h.replicaInfo.overrides))}let i=n[o.id],s=e.duplicatedFrom;Q.copyToNode(e,o,i),e.duplicatedFrom=s;let a=!1;Ct(e)&&(a=!0,It(e,n,o),Ye(o,e));let d=e.id,c=o.children;if(!c)return;let u=new Array(c.length);for(let h=0,m=c.length;h<m;h++)u[h]=fr(d,n,c[h],d,a);e.children=u}}function fr(o,t,e,r,n){let i=M({__class:e.__class,id:o+e.id,parentid:r});f(i,"Failed to create replica node");let s=t[e.id];if(Q.copyToNode(i,e,s),i.duplicatedFrom=null,n&&Ye(e,i),e.children){let a=e.children,d=new Array(a.length);for(let c=0,u=a.length;c<u;c++)d[c]=fr(o,t,a[c],i.id,n);i.children=d}return i}var P=b("remote:sync"),pr=2**52,se=class{constructor(t,e=0,r){this.timeline=t;l(this,"rollingDiff",null);l(this,"session",Math.floor(Math.random()*pr));l(this,"seq",0);l(this,"treeVersion",0);l(this,"updatesSeen",0);l(this,"init",0);l(this,"expectingInitialUpdates",0);l(this,"localUpdatesInFlight",[]);l(this,"localUpdatesAtInit",[]);l(this,"hasError",!1);l(this,"waitingForTree",!1);this.setTree(t.tree,e,r)}get waitingForInitialUpdates(){return this.expectingInitialUpdates>this.updatesSeen}get isLoading(){return this.waitingForTree||this.waitingForInitialUpdates}get isReady(){return!(this.hasError||this.waitingForTree||this.waitingForInitialUpdates)}get tree(){return this.timeline.tree}error(t){return this.hasError=!0,Error(t)}verify(t,e){let r=this.timeline.getTreeForVersion(t);if(!r)return P.info("verify: unable to find tree with version",t),!0;let n=r.computeTreeHash();if(n!==e){if(P.warn("verify: failed",n,"!==",e),e===0)return!0;P.reportError("Tree verification failed",{localHash:n,serverHash:e,treeVersion:t,treeSize:r.size()})}else P.debug("verify: passed; hash:",e);return n===e}setTree(t,e,r){P.info("setTree",e),this.timeline.reset(t,r),this.setRemoteTreeVersion(e),!!r?.isLoading&&z.isOn("rollingDiff")&&(this.rollingDiff=new Be,this.rollingDiff.addChanges(r?.initialChanges)),this.treeVersion=e,this.waitingForTree=!1,this.hasError=!1,this.localUpdatesInFlight=[]}resetSession(){this.treeVersion=0,this.session=Math.floor(Math.random()*pr),this.localUpdatesInFlight=[],this.localUpdatesAtInit=[]}debugResetSessionAndTree(t){this.resetSession(),this.setTree(t,0)}handleInit(t,e){return this.init+=1,this.init===1&&R("wsTreeInitMessages"),P.info("init",this.init,{treeVersion:t,initialUpdates:e,localTreeVersion:this.treeVersion}),P.debug("init updates:",{seen:this.updatesSeen,inFlight:this.localUpdatesInFlight.length,previous:this.localUpdatesAtInit.length}),this.hasError=!1,this.expectingInitialUpdates=e,this.updatesSeen=0,this.localUpdatesAtInit=this.localUpdatesInFlight.slice(),this.treeVersion!==t||this.waitingForTree?(this.waitingForTree=!0,!0):!1}trimForShallowLoading(){let t=this.timeline,e=this.getRemoteIndex()-3;e<=0||(t.trimmed+=e,P.debug("trim",e,"new offset:",t.trimmed,"entries.length:",t.entries.length,"after load"),t.entries.splice(0,e),f(this.timeline.remoteTreeIndex===0||this.getRemoteIndex()>=0,"must have some buffer before remoteTreeIndex"))}loadedAllScopes(){let t=this.timeline;P.info("done loading, took:",Math.round((performance.now()-t.resetTime)/100)/10,"seconds"),f(t.isPartialLoading,"Must be in loading mode"),t.isPartialLoading=!1,this.rollingDiff=null;let e=this.getRemoteEntry();e&&(e.version=t.remoteTreeVersion,this.trimForShallowLoading())}loadOneScope(t,e){let r=this.timeline;P.debug("loadOneScope:",t.id),f(r.isPartialLoading,"Must be loading"),f(!t.cache.isShallowLoad,"Scope must not be shallow");let n=this.getRemoteEntry();f(n,"remote tree is missing");let i=r.tree.isViewOnly;n.tree.editClosed=!1,n.tree.isViewOnly=!1,n.tree.inEditor=!1,n.tree.makeLatest();let s=new Set,a=n.tree.root.children.findIndex(c=>c.id===t.id);if(t.__class==="WebPageNode"||t.__class==="SmartComponentNode"){hr(t),n.tree=n.tree.commitWithLoadedScope(t);for(let c of t.walk())r.trackChange(c.id),s.add(c.id)}else n.tree.remove(t.id),n.tree.insertNode(t,n.tree.root.id,a);if(this.rollingDiff){let c=this.rollingDiff.getChanges();s.size>0?et(c,s)&&E(n.tree,c):E(n.tree,c)}else{let c=0,u=s.size>0,h=this.getRemoteIndex();for(let m of r.entries){if(c>h)break;c++,!m.wasScopeInsert&&(u&&!et(m.changes,s)||(u=!1,E(n.tree,m.changes)))}}a===-1?f(!n.tree.get(t.id),"Scope must have been deleted by remote diffs"):n.tree.loadReplicasAndCodeComponents(t);let d=n.tree.commit((c,u)=>{let h=c?.id??u?.id;h&&r.trackChange(h)});return n.tree.inEditor=!0,d.inEditor=!0,this.incrementRemoteTreeIndex(),e||(r.latestReversibleNodeChanges=null),this.addTreeToTimeline(d),r.legacyMode&&r.invalidateAllCursors(),d.isViewOnly=i,this.rollingDiff&&this.trimForShallowLoading(),r.tree}getRemoteEntry(){return this.timeline.getEntry(this.getRemoteIndex())}setRemoteTreeVersion(t){if(this.timeline.remoteTreeVersion=t,this.timeline.isPartialLoading)return;let e=this.getRemoteEntry();f(e,"remote tree is missing"),e.version=t}};var mr=b("remote:sync"),He=class extends se{constructor(e,r=0,n){super(e,r,n);l(this,"lastValidLocalIndex",0);l(this,"lastRemoteIndex",0);this.timeline.enableAddRemoveOptimizations=!1}setTree(e,r,n){super.setTree(e,r,n),this.lastValidLocalIndex=0,this.lastRemoteIndex=0}handleRemoteUpdate(e,r){if(this.hasError||this.waitingForTree)return;mr.trace("this:",this.session,this.seq,"at:",this.treeVersion,"update:",e),this.treeVersion=r.rows.reduce((c,u)=>Math.max(c,u.seq),this.treeVersion);let n=this.timeline,i=this.timeline.getLastEntry();f(i,"remote tree is missing");let s=n.tree.isViewOnly;i.tree.editClosed=!1,i.tree.isViewOnly=!1,i.tree.makeLatest(),i.tree.beginAllowPartialScopeAccess();let a=cr(i.tree,e),{changes:d}=Mt(i.tree,a);for(let c of d)n.trackChange(c.id,c);for(let c of i.tree.getNodesChangedByCommit())n.trackChange(c.id);return n.latestReversibleNodeChanges=null,this.timeline.addEntry(a,d,[],!1),this.lastRemoteIndex=this.timeline.length-1,this.trim(),this.setRemoteTreeVersion(this.treeVersion),i.tree.endAllowPartialScopeAccess(),a.isViewOnly=s,d}addTreeToTimeline(e){let r=this.timeline.addEntry(e,[]);r.wasScopeInsert=!0}getRemoteIndex(){return this.timeline.entries.length-1}incrementRemoteTreeIndex(){}hasOnlyEmptyChangesForRemote(){let e=this.lastValidLocalIndex,r=this.timeline.length-1;return e>=r?!0:this.timeline.computeForwardChanges(e,r).length===0}resetTreesForRecovery(){return this.timeline.resetTreesForRecovery(this.lastRemoteIndex-this.timeline.trimmed,this.lastValidLocalIndex-this.lastRemoteIndex)}trimForShallowLoading(){}trim(){if(this.timeline.isPartialLoading)return;let e=this.lastValidLocalIndex-this.timeline.trimmed-100;e<=75||(this.timeline.trimmed+=e,mr.debug("trim",e,"new offset:",this.timeline.trimmed,"entries.length:",this.timeline.entries.length),this.timeline.entries.splice(0,e))}};function oe(o){let{appEnvironment:t,session:e,seq:r,count:n,reasons:i,changes:s}=o;return{appEnvironment:t,session:e,seq:r,changes:s,count:n,reasons:i}}function gr(o,t){return{...o,next:t}}var rn={cache:!0,update:!0,mutable:!0,children:!0};function nn(o,t){if(o!=="cached")return t}function yr(o){return JSON.parse(JSON.stringify(o,nn))}function We(o,t,e){let r=new Set,n=!1;function i(a,d){r.add(a.id),d+="."+a.id;let c=t.get(a.id);if(!c)n=!0,e.push("-node: "+d+(xe(a)?" (replica child)":""));else{let u=[],h=a.children?.map(p=>p.id).join(","),m=c.children?.map(p=>p.id).join(",");h!==m&&u.push(" .children: ["+h+"] != ["+m+"]");for(let[p,g]of a.entries()){if(p in rn)continue;let y=c[p];de(g,y)?g&&typeof g=="object"&&g.__proto__!==(typeof y=="object"&&y&&"__proto__"in y?y.__proto__:void 0)&&u.push(" ."+p+": different prototypes"):(g===void 0||y===void 0||!de(yr(g),yr(y)))&&p!=="contentHash"&&u.push(" ."+p+": "+JSON.stringify(g)+" != "+JSON.stringify(y))}u.length>0&&(n=!0,e.push("!node: "+d+(xe(a)?" (replica child)":"")),e.push(...u))}for(let u of a.children??[])i(u,d)}function s(a,d){d+="."+a.id,r.has(a.id)||(n=!0,e.push("+node: "+d+(xe(a)?" (replica child)":"")));for(let c of a.children??[])s(c,d)}return i(o.root,""),s(t.root,""),n}var v=b("remote:connection"),G=b("remote:verify"),sn=5,br=class{constructor(t,e,r,n){this.userId=e;this.projectId=r;this.callbacks=n;l(this,"treeSync");l(this,"remoteUpdates",[]);l(this,"ignoreTreeVerifies",!1);l(this,"ignoreTreeVerifyVersion",0);l(this,"shouldCrashFromDebug",!1);l(this,"loader");l(this,"documentSize",0);l(this,"loaderPromise");l(this,"minSeqToSend",0);l(this,"unconfirmedCrdtRows",new Map);l(this,"crdtRowSeq",0);this.treeSync=new He(t),this.treeSync.waitingForTree=!0,window.store=this.store}get treeVersion(){return this.treeSync.treeVersion}get isReady(){return this.treeSync.isReady}get waitingForTree(){return this.treeSync.waitingForTree}get timeline(){return this.treeSync.timeline}get store(){return this.timeline.store}get isLoading(){return this.treeSync.isLoading}get localUpdatesInFlight(){return this.treeSync.localUpdatesInFlight}get localUpdatesAtInit(){return this.treeSync.localUpdatesAtInit}get hasError(){return this.treeSync.hasError}get init(){return this.treeSync.init}get session(){return this.treeSync.session}setTree(t,e,r){this.treeSync.setTree(t,e,r)}get hasUpdatesToProcess(){return!this.waitingForTree&&this.remoteUpdates.length>0}resetSession(){this.treeSync.resetSession(),this.unconfirmedCrdtRows.clear(),this.crdtRowSeq=0}debugResetSessionAndTree(t){this.treeSync.debugResetSessionAndTree(t)}debugCrash(){this.shouldCrashFromDebug=!0}canProcessChanges(){if(this.treeSync.trim(),!this.treeSync.isReady||this.shouldCrashFromDebug){if(this.treeSync.hasOnlyEmptyChangesForRemote())return!1;let t="is not ready";throw this.treeSync.hasError?t="had an error":this.treeSync.waitingForTree?t="is waiting for tree data":this.treeSync.waitingForInitialUpdates?t="is waiting for initial updates":this.shouldCrashFromDebug&&(this.shouldCrashFromDebug=!1,t="is doing a deliberate crash test"),this.treeSync.error("cannot create local updates when the document "+t)}return!0}processViewOnly(){this.store.seq<this.minSeqToSend||(this.minSeqToSend=this.store.seq+1,v.warn("cannot create local updates when the user is a viewer"))}resumeLoadingScopes(){this.loader?.resumeLoadingScopes()}handleRows(t,e){this.remoteUpdates.push(e)}handleConfirmRows(t){for(let[e,r]of this.unconfirmedCrdtRows.entries())r.seq<=t&&(this.unconfirmedCrdtRows.delete(e),v.debug("confirmed CRDT row:",e,"seq:",r.seq));v.debug("confirmed CRDT rows up to seq:",t,"remaining unconfirmed:",this.unconfirmedCrdtRows.size)}handleInit(t,e){return this.remoteUpdates.length=0,{needsDownload:this.treeSync.handleInit(t,e)}}handleMigration(t){this.treeSync.treeVersion=t}handleReload(t){this.remoteUpdates.length=0,this.treeSync.hasError=!0;let e=new Error(t||"Server reloaded document.");this.callbacks.error(e)}handleTreeUpdate(){throw new Error("Json tree updates cannot be handled by Crdt data handler")}handleTreeVerify(t,e,r){if(!this.treeSync.isReady||this.ignoreTreeVerifies||this.ignoreTreeVerifyVersion===e)return;if(!this.treeSync.verify(e,r)){let s=this.treeSync.timeline.getTreeForVersion(e);if(s){let d=this.treeSync.timeline.entries.slice();this.verifyLocalTreeWithServer(t,s,e,d)}this.remoteUpdates.length=0,this.treeSync.hasError=!0;let a=new Error("Local document out of sync with document on server.");this.callbacks.error(a);return}let n=De(),i=!!window.location.hostname.match(/development/u);if(n||i){let s=this.treeSync.timeline.getTreeForVersion(e);if(s){let a=this.treeSync.timeline.entries.slice();this.verifyLocalTreeWithServer(t,s,e,a)}}}processRemoteUpdates(){if(v.debug("processRemoteUpdates: starting - waitingForTree:",this.treeSync.waitingForTree,"waitingForInitialUpdates:",this.treeSync.waitingForInitialUpdates,"hasError:",this.treeSync.hasError,"isReady:",this.isReady,"remoteUpdates.length:",this.remoteUpdates.length),this.treeSync.waitingForTree){v.debug("processRemoteUpdates: exiting early - waitingForTree=true");return}let t;try{if(f(!this.timeline.tree.hasUncommittedChanges(),"tree must not have uncommitted changes"),this.shouldCrashFromDebug)throw this.shouldCrashFromDebug=!1,Error("RemoteDocument CrashTest");for(;this.remoteUpdates.length>0;){let e=this.remoteUpdates.shift();if(!e)break;t=e;let r=this.writeServerUpdateToTheStore(e);if(this.ensureAllScopesAreLoaded(r),r){let n=this.treeSync.handleRemoteUpdate(r,e);n&&this.loader?.addNodeChanges(n)}e.rows.length>0&&this.treeSync.expectingInitialUpdates>0&&(v.debug("handleRows: counting",e.rows.length,"rows as updates toward initial updates"),this.treeSync.updatesSeen+=e.rows.length,v.debug("handleRows: updatesSeen now:",this.treeSync.updatesSeen,"still expecting:",this.treeSync.expectingInitialUpdates-this.treeSync.updatesSeen))}if(this.loader){let e=this.timeline.tree.root.children;if(!e.some(n=>V(n)&&n.isValid())){v.info("cannot show any page, forcing load of next page");let n=e.find(s=>V(s));if(!n)throw Error("No scope to load");let i=this.loader.loadScope(n.id);if(!i)throw Error("Unable to load scope");this.treeSync.loadOneScope(i,!1)}}this.callbacks.updateProcessed(this.timeline.tree)}catch(e){let r=Ce(e);throw this.remoteUpdates.length=0,v.error("Error processing remote updates:",r),v.debug("Last update:",t),this.callbacks.errorRecoverable(),this.treeSync.error(r.message),r}}async verifyTreeWithServer(){let t=new URL(`/projects/${this.projectId}/tree/latest?forceSnapshot=true`,window.location.href),e;try{this.ignoreTreeVerifies=!0,e=await fetch(t,await ee.withAuthorizationHeader({}))}finally{this.ignoreTreeVerifies=!1}if(!e.ok)throw Error(`unable to fetch document json: ${e.status} ${e.statusText}`);let r=e.headers.get("etag")||"",n=Number.parseInt(r.match(/Version-(\d+)/u)?.[1]??"0",10);if(!Number.isFinite(n)||n<=0)throw Error(`unable to parse document tree version from: ${r}`);let i=this.treeSync.treeVersion-n,s=this.treeSync.timeline.getTreeForVersion(n);if(!s)throw Error(`unable to get the local tree for version ${n}`);this.ignoreTreeVerifyVersion=n;let a=await e.text(),d=await this.loadServerTree(a,t.toString(),n),c=this.compareTreeWithServerJson(s,d,n);if(c)throw c;return i}async loadServerTree(t,e,r){let n,i=new we(this.store,r,e,{partialParsing:!0,loadInBackground:!0,loadedData:t,requestIdleCallback:this.callbacks.requestIdleCallback});return i.on("loadedFirstData",s=>{i.on("loadedScope",a=>{let d=s.root.children.findIndex(c=>c.id===a.id);s.remove(a.id),s.insertNode(a,s.root.id,d),s=s.commit()}),i.on("loadedAllData",()=>{n=s})}),await i.start(),f(n,"loadedAllData not called"),n}clearRemoteUpdates(){this.remoteUpdates.length=0}sendRemainingInflightUpdates(t){let e=this.localUpdatesInFlight.length>0,r=this.unconfirmedCrdtRows.size>0;if(!e&&!r)return!1;let n=this.getRowsToSend();if(n.length>0&&t.sendMessage({type:"rows",value:{seq:++this.crdtRowSeq,rows:n}}),r){let i=Array.from(this.unconfirmedCrdtRows.values());i.length>0&&(v.debug("resending unconfirmed CRDT rows:",i.length),t.sendMessage({type:"rows",value:{seq:0,rows:i.map(s=>({client:s.client,seq:s.seq,id:s.id,key:s.key,value:s.value,user:s.user}))}}))}return!0}resendPreviousLocalUpdates(t){f(this.isReady);let e=this.localUpdatesAtInit.filter(n=>!n.confirmed);if(e.length>0){v.debug("resending local updates:",e.length);for(let n of e)t.sendMessage({type:"treeUpdate",value:oe(n)})}let r=Array.from(this.unconfirmedCrdtRows.values());r.length>0&&(v.debug("resending unconfirmed CRDT rows during reconnection:",r.length),t.sendMessage({type:"rows",value:{seq:0,rows:r.map(n=>({client:n.client,seq:n.seq,id:n.id,key:n.key,value:n.value,user:n.user}))}}))}cancelAndClearLoader(){this.loader?.scheduler.cancel(),this.loader=void 0}maybeSend(t){if(!this.treeSync.isReady||this.store.seq<this.minSeqToSend)return"nothingToSend";let e=this.treeSync.localUpdatesInFlight.length;if(e>=sn)return"postpone";let r=this.getRowsToSend();return r.length>0?(v.debug("sending CRDT rows:",e,r.length,"rows"),t.sendMessage({type:"rows",value:{seq:++this.crdtRowSeq,rows:r}}),"didSend"):"nothingToSend"}writeServerUpdateToTheStore(t){let e=new J({client:0,user:"temp-user"});return e.addRows(t.rows),ur(this.store,e)}ensureAllScopesAreLoaded(t){if(!this.loader)return;let e=new Set,r=this.timeline.tree;for(let[n,i]of t){let s=i?.parentid;if(!s)continue;let a=r.get(s);if(a){let c=r.getScopeNodeFor(a);c&&e.add(c.id)}let d=r.get(n)?.parentid;if(d){let c=r.get(d);if(c){let u=r.getScopeNodeFor(c);u&&e.add(u.id)}}}for(let n of e){if(this.loader.hasLoadedScope(n))continue;let i=this.loader.loadScope(n);i&&this.treeSync.loadOneScope(i,!1)}}createLoader(t,e,r){this.loader?.scheduler.cancel();let n=new we(this.store,e,t,r);return this.loader=n,n.on("loadedFirstData",()=>{this.minSeqToSend=this.store.seq,v.debug("Reset last sent seq to current store length:",this.minSeqToSend)}),this.loader}finishLoading(){this.loader=void 0}async verifyLocalTreeWithServer(t,e,r,n){try{let i=t.replace(/\d+\.json/u,r+".json"),s=await fetch(i,await ee.withAuthorizationHeader({}));if(!s.ok)throw Error(`unable to fetch document json: ${s.status} ${s.statusText}`);let a=await s.text(),d=await this.loadServerTree(a,i,r);this.compareTreeWithServerJson(e,d,r,n)}catch(i){G.error("Error:",i)}}compareTreeWithServerJson(t,e,r,n){G.debug("local:",t.computeTreeHash(),t.size(),"remote:",e.computeTreeHash(),e.size(),"version:",r);let i,s=[];return We(t,e,s)?(G.warn(`trees are different
`+s.join(`
`)),n&&G.debug("timeline.entries",n),i=Error("Local document different from server document."),G.reportError(i,{differences:s,changes:n?.slice(-25).map(d=>d.changes)})):s.length>0?G.debug(`trees have warnings:
`+s.join(`
`)):G.debug("trees are same"),i}getRowsToSend(){let t=this.store.getFirstRowForSeq(this.minSeqToSend),e=this.store.getRows(t);v.debug("getRowsToSend: allRows from store:",e.length,"store total length:",this.store.length),v.debug("store.client:",this.store.client),v.debug("store.client (hashed):",this.store.client);let r=e.filter(i=>{let s=i.client===this.store.client,a=i.seq>=this.minSeqToSend;return s&&a}).map(i=>({id:i.id,seq:i.seq,client:i.client,key:i.key,value:i.value,user:this.userId}));r.forEach(i=>{let s={client:i.client,seq:i.seq,id:i.id,key:i.key,value:i.value,user:this.userId,timestamp:Date.now(),retryCount:0},a=`${i.client}_${i.seq}`;this.unconfirmedCrdtRows.set(a,s),v.debug("tracking CRDT row:",a,"seq:",i.seq)}),v.debug("getRowsToSend: returning",r.length,"rows");let n=r.reduce((i,s)=>Math.max(i,s.seq),0);return v.debug("Setting minSeqToSend from",this.minSeqToSend,"to",n+1),this.minSeqToSend=n+1,r}loadedAllScopes(){this.treeSync.loadedAllScopes()}loadOneScope(t,e){return this.treeSync.loadOneScope(t,e)}hasUnconfirmedChanges(){return this.unconfirmedCrdtRows.size>0}resetTreesForRecovery(){return this.treeSync.resetTreesForRecovery()}error(t){return this.treeSync.error(t)}};function Sr(o){return typeof o=="object"&&o!==null&&"next"in o}function $e(o){return Sr(o)&&"session"in o}function Ke(o){return Sr(o)&&"changes"in o&&Array.isArray(o.changes)}var L=b("remote:sync"),Je=class extends se{constructor(){super(...arguments);l(this,"localChangesSentToRemote",0)}setTree(e,r,n){super.setTree(e,r,n),this.localChangesSentToRemote=0}handleRemoteUpdate(e){if(this.hasError||this.waitingForTree)return;f(typeof e.next=="number","must be a valid tree update");let r=e.next;if(L.trace("this:",this.session,this.seq,"at:",this.treeVersion,"update:",e),r!==this.treeVersion+1){if(r<=this.treeVersion){L.debug("ignoring old update:",r," <= ",this.treeVersion);return}throw this.error("missing update: "+this.treeVersion+" + 1 != "+r)}if(this.updatesSeen+=1,this.treeVersion=r,$e(e)&&e.session===this.session){let n=this.localUpdatesInFlight[0];if(n?.seq===e.seq)this.localUpdatesInFlight.shift(),this.confirmLocalChangesByRemote(n.count,r),n.confirmed=!0;else{let i=this.localUpdatesAtInit.find(s=>s.seq===e.seq);if(i)this.insertRemoteChanges(i.changes,r),i.confirmed=!0;else{let s=this.localUpdatesInFlight.findIndex(d=>d.seq===e.seq),a=s===-1?"unknown local update: "+e.seq+" != "+n?.seq:"missing local update: "+e.seq+" != "+n?.seq+", is index: "+s;throw this.error(a)}}}else Ke(e)?e.changes.length>0&&this.insertRemoteChanges(e.changes,r):L.reportErrorOncePerMinute(new Error("Unknown remote update"),{update:e})}confirmLocalChangesByRemote(e,r=0){let n=this.timeline;if(f(e>=1,"cannot confirm less than one change"),f(this.localChangesSentToRemote>=e,"cannot confirm local changes that have not been sent"),f(n.remoteTreeIndex<n.localTreeIndex,"must have unconfirmed local changes"),this.rollingDiff)for(let i=1;i<=e;i++)this.rollingDiff.addChanges(n.getEntry(n.remoteTreeIndex+i)?.changes);return this.localChangesSentToRemote-=e,n.incrementRemoteTreeIndex(e),this.setRemoteTreeVersion(r),n.tree}insertRemoteChanges(e,r=0){let n=this.timeline;L.debug("insertRemoteChanges:",e.length),f(n.tree===n.getLastEntry().tree,"tree out of sync"),f(n.remoteTreeIndex<=n.localTreeIndex,"remote tree too far ahead"),this.rollingDiff&&this.rollingDiff.addChanges(e);let i=this.getRemoteEntry();f(i,"remote tree is missing");let s=n.tree.isViewOnly;i.tree.editClosed=!1,i.tree.isViewOnly=!1,i.tree.makeLatest(),i.tree.beginAllowPartialScopeAccess(),E(i.tree,e);let a=i.tree.commitDiffs();for(let c of e)n.trackChange(c.id,c);for(let c of i.tree.getNodesChangedByCommit())n.trackChange(c.id);n.incrementRemoteTreeIndex(1),n.latestReversibleNodeChanges=null;let d=n.entries.length-this.getRemoteIndex();return f(d>=0,"computed rebase is off"),d===0?this.addRemoteTreeWithChanges(a,e):this.rebaseRemoteTreeWithChanges(a,e,d),this.trim(),this.setRemoteTreeVersion(r),i.tree.endAllowPartialScopeAccess(),a.isViewOnly=s,n.tree}addRemoteTreeWithChanges(e,r){L.trace("addRemoteTreeWithChanges:",r.length);let n=this.timeline.getLastEntry();return f(e.lineage===n.tree.lineage,"Trees must belong to the same line."),f(!e.hasUncommittedChanges(),"Tree cannot have uncommitted changes."),n.tree!==e&&n.tree.releaseMemory(),this.timeline.addEntry(e,r)}rebaseRemoteTreeWithChanges(e,r,n){let i=this.timeline;L.debug("rebaseRemoteTreeWithChanges:",n,"changes:",r.length),f(e.lineage===i.getLastEntry().tree.lineage,"Trees must belong to the same line."),f(!e.hasUncommittedChanges(),"Tree cannot have uncommitted changes."),f(i.entries.length>=n,"rebase",n,"> commits",i.entries.length);let s=i.entries.splice(i.entries.length-n,n);f(s.length===n,"must have",n,"entries to process");let a=i.addEntry(e,r,[],!0),d=e;for(let c=0;c<n;c++){let u=s[c];E(e,u.changes),e=e.commitDiffs();for(let h of u.changes)i.trackChange(h.id,h);for(let h of d.getNodesChangedByCommit())i.trackChange(h.id);i.addEntry(e,u.changes,u.editReasons,u.wasRebase),e!==d&&(d.releaseMemory(),d=e)}return i.tree=e,a}addTreeToTimeline(e){let n=this.timeline.entries.length-this.getRemoteIndex();f(n>=0,"computed rebase is off");let i;n===0?i=this.addRemoteTreeWithChanges(e,[]):i=this.rebaseRemoteTreeWithChanges(e,[],n),i.wasScopeInsert=!0}loadCompleteTree(e,r=0){let n=this.timeline;L.debug("load complete tree:",n.tree.sizeAtStart(),"->",e.size(),"entries:",n.entries.length),f(n.trimmed===0,"cannot load complete tree while having local changes"),f(!e.hasUncommittedChanges(),"tree should be clean"),n.entries.forEach((d,c)=>{c>n.remoteTreeIndex||E(e,d.changes)}),e.hasUncommittedChanges()&&(e=e.commitDiffs());let i=[],s=n.tree;if(s.sizeAtStart()*2>e.size()){let d={};for(let c of e.root.walk()){let u=s.getNodeAtStart(c.id)||void 0,h=Ne(u,c);h&&(d[h.id]=h),n.trackChange(c.id,h)}i=Object.values(d),L.debug("load complete tree, diff:",i.length)}else n.invalidateAllCursors(),L.debug("load complete tree, resending:",n.tree.size());n.incrementRemoteTreeIndex(1),n.latestReversibleNodeChanges=null;let a=n.entries.length-n.remoteTreeIndex;return f(a>=0,"computed rebase is off"),e.lineage!==n.tree.lineage?(n.reset(e),this.setRemoteTreeVersion(r),n.tree):(a===0?this.addRemoteTreeWithChanges(e,i):this.rebaseRemoteTreeWithChanges(e,i,a),this.setRemoteTreeVersion(r),this.trim(),n.tree.forEachNode(d=>n.trackChange(d.id)),n.tree)}incrementRemoteTreeIndex(){this.timeline.incrementRemoteTreeIndex(1)}getRemoteIndex(){return this.timeline.remoteTreeIndex-this.timeline.trimmed}getUnconfirmedChangeCount(){return this.timeline.localTreeIndex-this.timeline.remoteTreeIndex}hasChangesForRemote(){let e=this.timeline.remoteTreeIndex+this.localChangesSentToRemote,r=this.timeline.localTreeIndex;return f(e<=r,"inconsistency in getting local changes to send"),e<r}hasOnlyEmptyChangesForRemote(){let e=this.timeline.remoteTreeIndex+this.localChangesSentToRemote,r=this.timeline.localTreeIndex;return e>=r?!0:this.timeline.computeForwardChanges(e,r).length===0}createUpdateToSend(){if(!this.isReady)throw Error("cannot create updates while not ready");if(!this.hasChangesForRemote())return null;let{changes:e,count:r,reasons:n}=this.getForwardChangesForRemote(),i=++this.seq,s={session:this.session,seq:i,changes:e,count:r,reasons:n,confirmed:!1};return this.localUpdatesInFlight.push(s),s}getForwardChangesForRemote(){let e=this.timeline.remoteTreeIndex+this.localChangesSentToRemote,r=this.timeline.localTreeIndex,n=this.timeline.getChangesBetweenEntries(e,r);return this.localChangesSentToRemote+=n.count,n}commitAndCreateUpdate(e=0){f(Ie.isTest),this.timeline.commitLocalTree();let r=this.createUpdateToSend();return r?gr(r,e):null}resetTreesForRecovery(){return L.info("reset trees for recovery, remote:",this.getRemoteIndex(),"last index:",this.timeline.localTreeIndex,"number of entries to reapply to remote tree",this.localChangesSentToRemote),this.timeline.resetTreesForRecovery(this.getRemoteIndex(),this.localChangesSentToRemote)}trim(){if(this.timeline.isPartialLoading)return;let e=0;this.timeline.remoteTreeIndex>0?e=this.getRemoteIndex()-100:e=this.timeline.localTreeIndex-this.timeline.trimmed-100,!(e<=75)&&(this.timeline.trimmed+=e,L.debug("trim",e,"new offset:",this.timeline.trimmed,"entries.length:",this.timeline.entries.length),this.timeline.entries.splice(0,e),f(this.timeline.remoteTreeIndex===0||this.getRemoteIndex()>=0,"must have some buffer before remoteTreeIndex"))}};var ae=b("remote:connection"),Y=b("remote:verify"),on=5,vr=class{constructor(t,e,r){this.projectId=e;this.callbacks=r;l(this,"treeSync");l(this,"remoteUpdates",[]);l(this,"ignoreTreeVerifies",!1);l(this,"ignoreTreeVerifyVersion",0);l(this,"shouldCrashFromDebug",!1);l(this,"loader");this.treeSync=new Je(t),this.treeSync.waitingForTree=!0}get init(){return this.treeSync.init}setTree(t,e,r){this.treeSync.setTree(t,e,r)}get timeline(){return this.treeSync.timeline}get treeVersion(){return this.treeSync.treeVersion}get isReady(){return this.treeSync.isReady}get waitingForTree(){return this.treeSync.waitingForTree}get isLoading(){return this.treeSync.isLoading}get session(){return this.treeSync.session}resetSession(){this.treeSync.resetSession()}debugResetSessionAndTree(t){this.treeSync.debugResetSessionAndTree(t)}debugCrash(){this.shouldCrashFromDebug=!0}canProcessChanges(){if(this.treeSync.trim(),!this.treeSync.isReady||this.shouldCrashFromDebug){if(this.treeSync.hasOnlyEmptyChangesForRemote())return!1;let t="is not ready";throw this.treeSync.hasError?t="had an error":this.treeSync.waitingForTree?t="is waiting for tree data":this.treeSync.waitingForInitialUpdates?t="is waiting for initial updates":this.shouldCrashFromDebug&&(this.shouldCrashFromDebug=!1,t="is doing a deliberate crash test"),this.treeSync.error("cannot create local updates when the document "+t)}return!0}processViewOnly(){if(!this.treeSync.hasChangesForRemote())return;let{changes:t,count:e}=this.treeSync.getForwardChangesForRemote();ae.warn("cannot create local updates when the user is a viewer, ignoring:",t),this.treeSync.confirmLocalChangesByRemote(e)}maybeSend(t){if(!this.treeSync.isReady||!this.treeSync.hasChangesForRemote())return"nothingToSend";let e=this.treeSync.localUpdatesInFlight.length;if(e>=on)return"postpone";let r=this.treeSync.createUpdateToSend();return r?(ae.debug("sending update:",e,r.changes.length,r.reasons),t.sendMessage({type:"treeUpdate",value:oe(r)}),"didSend"):"nothingToSend"}resumeLoadingScopes(){this.loader?.resumeLoadingScopes()}handleRows(){throw Error("Crdt tree updates cannot be handled by Json data handler")}handleConfirmRows(){throw Error("Crdt tree updates cannot be handled by Json data handler")}get hasUpdatesToProcess(){return!this.waitingForTree&&this.remoteUpdates.length>0}handleInit(t,e){return this.remoteUpdates.length=0,{needsDownload:this.treeSync.handleInit(t,e)}}handleMigration(t){this.treeSync.treeVersion=t}handleReload(t){this.remoteUpdates.length=0,this.treeSync.hasError=!0;let e=new Error(t||"Server reloaded document.");this.callbacks.error(e)}handleTreeVerify(t,e,r){if(!this.treeSync.isReady||this.ignoreTreeVerifies||this.ignoreTreeVerifyVersion===e)return;if(!this.treeSync.verify(e,r)){let s=this.treeSync.timeline.getTreeForVersion(e);if(s){let d=this.treeSync.timeline.entries.slice();this.verifyLocalTreeWithServer(t,s,e,d)}this.remoteUpdates.length=0,this.treeSync.hasError=!0;let a=new Error("Local document out of sync with document on server.");this.callbacks.error(a);return}let n=De(),i=!!window.location.hostname.match(/development/u);if(n||i){let s=this.treeSync.timeline.getTreeForVersion(e);if(s){let a=this.treeSync.timeline.entries.slice();this.verifyLocalTreeWithServer(t,s,e,a)}}}async verifyLocalTreeWithServer(t,e,r,n){try{let i=t.replace(/\d+\.json/u,r+".json"),s=await fetch(i,await ee.withAuthorizationHeader({}));if(!s.ok)throw Error(`unable to fetch document json: ${s.status} ${s.statusText}`);let a=await s.text(),d=await this.loadServerTree(a,i,r);this.compareTreeWithServerJson(e,d,r,n)}catch(i){Y.error("Error:",i)}}compareTreeWithServerJson(t,e,r,n){Y.debug("local:",t.computeTreeHash(),t.size(),"remote:",e.computeTreeHash(),e.size(),"version:",r);let i,s=[];return We(t,e,s)?(Y.warn(`trees are different
`+s.join(`
`)),n&&Y.debug("timeline.entries",n),i=Error("Local document different from server document."),Y.reportError(i,{differences:s,changes:n?.slice(-25).map(d=>d.changes)})):s.length>0?Y.debug(`trees have warnings:
`+s.join(`
`)):Y.debug("trees are same"),i}handleTreeUpdate(t){this.remoteUpdates.push(t)}processRemoteUpdates(){if(this.treeSync.waitingForTree)return;let t;try{if(f(!this.timeline.tree.hasUncommittedChanges(),"tree must not have uncommitted changes"),this.shouldCrashFromDebug)throw this.shouldCrashFromDebug=!1,Error("RemoteDocument CrashTest");for(;this.remoteUpdates.length>0;){let e=this.remoteUpdates.shift();if(!e)break;t=e,this.ensureAllScopesAreLoaded(e),this.treeSync.handleRemoteUpdate(e),this.loader&&!$e(e)&&this.loader.addNodeChanges(e.changes)}if(this.loader){let e=this.timeline.tree.root.children;if(!e.some(n=>V(n)&&n.isValid())){ae.info("cannot show any page, forcing load of next page");let n=e.find(s=>V(s));if(!n)throw Error("No scope to load");let i=this.loader.loadScope(n.id);if(!i)throw Error("Unable to load scope");this.treeSync.loadOneScope(i,!1)}}this.callbacks.updateProcessed(this.timeline.tree)}catch(e){let r=Ce(e);throw this.remoteUpdates.length=0,ae.error("Error processing remote updates:",r),ae.debug("Last update:",t),this.treeSync.error(r.message),this.callbacks.errorRecoverable(),r}}ensureAllScopesAreLoaded(t){if(!this.loader||!Ke(t))return;let e=new Set;for(let r of t.changes)r.previousScope&&(e.add(r.previousScope),e.add(r.to.parentid));for(let r of e){if(this.loader.hasLoadedScope(r))continue;let n=this.loader.loadScope(r);n&&this.treeSync.loadOneScope(n,!1)}}createLoader(t,e,r){this.loader?.scheduler.cancel();let n=new W(e,t,r);return this.loader=n,this.loader}async verifyTreeWithServer(){let t=new URL(`/projects/${this.projectId}/tree/latest?forceSnapshot=true`,window.location.href),e;try{this.ignoreTreeVerifies=!0,e=await fetch(t,await ee.withAuthorizationHeader({}))}finally{this.ignoreTreeVerifies=!1}if(!e.ok)throw Error(`unable to fetch document json: ${e.status} ${e.statusText}`);let r=e.headers.get("etag")||"",n=Number.parseInt(r.match(/Version-(\d+)/u)?.[1]??"0",10);if(!Number.isFinite(n)||n<=0)throw Error(`unable to parse document tree version from: ${r}`);let i=this.treeSync.treeVersion-n,s=this.treeSync.timeline.getTreeForVersion(n);if(!s)throw Error(`unable to get the local tree for version ${n}`);this.ignoreTreeVerifyVersion=n;let a=await e.text(),d=await this.loadServerTree(a,t.toString(),n),c=this.compareTreeWithServerJson(s,d,n);if(c)throw c;return i}async loadServerTree(t,e,r){let n,i=new W(r,e,{partialParsing:!0,loadInBackground:!0,loadedData:t,requestIdleCallback:this.callbacks.requestIdleCallback});return i.on("loadedFirstData",s=>{i.on("loadedScope",a=>{let d=s.root.children.findIndex(c=>c.id===a.id);s.remove(a.id),s.insertNode(a,s.root.id,d),s=s.commit()}),i.on("loadedAllData",()=>{n=s})}),await i.start(),f(n,"loadedAllData not called"),n}clearRemoteUpdates(){this.remoteUpdates.length=0}get localUpdatesInFlight(){return this.treeSync.localUpdatesInFlight}get localUpdatesAtInit(){return this.treeSync.localUpdatesAtInit}get hasError(){return this.treeSync.hasError}sendRemainingInflightUpdates(t){if(this.localUpdatesInFlight.length===0)return!1;let e=this.treeSync.createUpdateToSend();return e&&t.sendMessage({type:"treeUpdate",value:oe(e)}),!0}resendPreviousLocalUpdates(t){f(this.isReady);let e=this.localUpdatesAtInit.filter(r=>!r.confirmed);if(e.length!==0){ae.debug("resending local updates:",e.length);for(let r of e)t.sendMessage({type:"treeUpdate",value:oe(r)})}}cancelAndClearLoader(){this.loader?.scheduler.cancel(),this.loader=void 0}finishLoading(){this.loader=void 0}loadOneScope(t,e){return this.treeSync.loadOneScope(t,e)}loadedAllScopes(){this.treeSync.loadedAllScopes()}hasUnconfirmedChanges(){return this.treeSync.getUnconfirmedChangeCount()>0}resetTreesForRecovery(){return this.treeSync.resetTreesForRecovery()}error(t){return this.treeSync.error(t)}};export{Ur as a,sr as b,ln as c,Yt as d,or as e,_e as f,Br as g,_r as h,Es as i,Hr as j,Wr as k,Rn as l,In as m,xn as n,it as o,W as p,br as q,vr as r};
//# sourceMappingURL=https://app.framerstatic.com/chunk-NTR3X2FQ.mjs.map
