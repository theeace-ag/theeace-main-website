import{a as h,b as S}from"https://app.framerstatic.com/chunk-FWMM76SF.mjs";import{j as r}from"https://app.framerstatic.com/chunk-AHQIRSXG.mjs";function M(s,e){throw e||new Error("Unexpected object: "+s)}var d=class extends Error{constructor(){super(...arguments);r(this,"name","ServiceError.UnknownError");r(this,"code",0);r(this,"status",0);r(this,"skipSentry",!1)}};(v=>{let s;(y=>(y[y.serviceNotFound=404]="serviceNotFound",y[y.serviceNotCompatible=426]="serviceNotCompatible",y[y.serviceGone=410]="serviceGone",y[y.implementation=500]="implementation",y[y.timedOut=504]="timedOut",y[y.badRequest=400]="badRequest",y[y.badResponse=422]="badResponse"))(s=v.Code||={});class e extends v{constructor(){super(...arguments);r(this,"code",404);r(this,"name","ServiceError.ServiceNotFound")}}v.ServiceNotFound=e;class t extends v{constructor(){super(...arguments);r(this,"code",426);r(this,"name","ServiceError.ServiceNotCompatible")}}v.ServiceNotCompatible=t;class i extends v{constructor(){super(...arguments);r(this,"code",410);r(this,"name","ServiceError.ServiceGone");r(this,"skipSentry",!0)}}v.ServiceGone=i;class o extends v{constructor(){super(...arguments);r(this,"code",500);r(this,"name","ServiceError.Implementation")}}v.Implementation=o;class n extends v{constructor(){super(...arguments);r(this,"code",504);r(this,"name","ServiceError.TimedOut")}}v.TimedOut=n;class c extends v{constructor(){super(...arguments);r(this,"code",400);r(this,"name","ServiceError.BadRequest")}}v.BadRequest=c;class u extends v{constructor(f,R){super(f);r(this,"code",422);r(this,"name","ServiceError.BadResponse");r(this,"response");this.response=R}}v.BadResponse=u;function p(a){if(!a)return new u;let l;O(a)&&(l=a.message);let f=m(a.code,l);return q(a)&&(f.code=a.code),B(a)&&(f.stack=a.stack),N(a)&&(f.skipSentry=a.skipSentry),j(a)&&(f.status=a.status),f}v.reconstructErrorResponse=p;function m(a,l){try{let f=a;switch(f){case 404:return new e(l);case 426:return new t(l);case 410:return new i(l);case 500:return new o(l);case 504:return new n(l);case 400:return new c(l);case 422:return new u(l);default:M(f)}}catch{return new v(l)}}function I(a){if(a instanceof v)return{code:a.code,message:a.message,stack:a.stack,skipSentry:a.skipSentry};let l,f,R,E,D;return typeof a=="string"?l=a:O(a)&&(l=a.message),B(a)&&(f=a.stack),N(a)&&(R=a.skipSentry),q(a)&&(E=a.code),j(a)&&(D=a.status),{code:E,message:l,stack:f,skipSentry:R,status:D}}v.toMessageBody=I})(d||={});function O(s){return typeof s=="object"&&s&&"message"in s&&typeof s.message=="string"}function B(s){return typeof s=="object"&&s&&"stack"in s&&typeof s.stack=="string"}function N(s){return typeof s=="object"&&s&&"skipSentry"in s&&typeof s.skipSentry=="boolean"}function q(s){return typeof s=="object"&&s&&"code"in s&&typeof s.code=="number"}function j(s){return typeof s=="object"&&s&&"status"in s&&typeof s.status=="number"}function $(s){S.log.error(s)}var g;(i=>{let s=Math.random;function e(){return`${s()}`}i.generateUniqueId=e;function t(){let o,n,c=new Promise((u,p)=>{o=u,n=p});return c.resolve=o,c.reject=n,c}i.newResolvablePromise=t})(g||={});var b;(t=>{function s(i){if(!i)return!1;switch(i.replay){case"latest":case void 0:break;default:return!1}return!0}t.isServiceStreamOptions=s;class e{constructor(o,n,c){this.method=o;this.options=n;this.helper=c;r(this,"oneway");r(this,"onewayCallback");r(this,"iterator");r(this,"cancelled",!1);r(this,"resolveCancelPromise");r(this,"rejectCancelPromise");this.oneway=n?.oneway??!1}[Symbol.asyncIterator](){if(this.oneway)throw new d.BadRequest("Cannot read a oneway stream through an AsyncIterator. Use read() with a void callback instead.");return this.iterator=this.newIterator(),this.iterator}async read(o){for(this.iterator=this.newIterator(),this.oneway&&(this.onewayCallback=n=>{if(!A(n))throw new d.BadResponse("StreamReader.onewayCallback received an invalid iterator result");if(n.done)return;if(o(n.value))throw new d.BadRequest("ServiceStream callbacks cannot be async if oneway = true.")});;){let n=await this.iterator.next();if(n.done)return;await o(n.value)}}async cancel(){this.cancelled=!0,await this.iterator?.return?.()}newIterator(){if(this.iterator)throw new d.BadRequest("ServiceStream instances can only be read once. If multiple AsyncIterators or read() calls are required, create a new stream for each by calling the associated service method. To broadcast events with an observer pattern, consider using a client-specific EventEmitter or similar.");let o=g.generateUniqueId(),n={done:!0,value:void 0},c=async m=>{if(!A(m))throw new d.BadResponse("StreamReader.next received an invalid iterator result for next()");return m},u=async()=>{try{let m=await this.helper({method:this.method,argument:this.options,stream:{id:o,method:"next"}},this.onewayCallback);return await c(m)}catch(m){throw this.cancelled=!0,m}},p=async()=>(this.cancelled||await new Promise((m,I)=>{this.resolveCancelPromise=m,this.rejectCancelPromise=I}),n);return{next:async()=>this.cancelled?n:Promise.race([u(),p()]),return:async()=>(this.cancelled=!0,this.resolveCancelPromise?.(),this.helper({method:this.method,stream:{id:o,method:"return"}}),n),throw:async m=>(this.cancelled=!0,this.rejectCancelPromise?.(m),this.helper({method:this.method,stream:{id:o,method:"return"}}),n)}}}t.StreamReader=e})(b||={});function A(s){return s?s.done===!0||s.done===!1&&s.value!==void 0:!1}var T=class{constructor(e){this.log=e;r(this,"expectWithoutDiscovery",(e,t)=>this.addRouter(t).expectWithoutDiscovery(e));r(this,"discover",async(e,t,i={})=>this.addRouter(t).discover(e,i));r(this,"unregister",async e=>{let t=[];for(let i of this.routers)i.channel===e&&t.push(i);if(t.length>0)for(let i of t)await i.unregisterAllImplementations(),this.routers.delete(i),i.destroy();else for(let i of this.routers)await i.unregisterImplementation(e)});r(this,"routers",new Set);r(this,"addRouter",e=>{for(let i of this.routers)if(i.channel===e)return i;let t=new x(e,this.log);return this.routers.add(t),t});r(this,"testable",{onlyRouter:()=>{if(this.routers.size!==1)throw new Error(`onlyRouter called on a ServiceManager with ${this.routers.size} routers, expected 1`);return this.routers.values().next().value}})}register(e){function t(i){return"service"in i&&"implementation"in i&&i.service!==void 0&&i.implementation!==void 0}return t(e)?(this.addRouter(e.channel).registerImplementation(e.implementation,e.service),()=>void this.unregister(e.implementation)):(this.addRouter(e.channel),()=>void this.unregister(e.channel))}};(t=>{let s;function e(){return s=s??new t,S._sharedServiceManagerIfTesting()??s}t.shared=e})(T||={});var x=class{constructor(e,t){this.channel=e;this.customLogger=t;r(this,"onMessage",e=>{try{e.type===h.MessageType.Request?e.id===h.onewayRequestId?this.onOnewayRequest(e):this.onRequest(e):e.type===h.MessageType.Response?e.method===w.method?this.onDiscoveryResponse(e):this.onResponse(e):e.type===h.MessageType.Error?this.onErrorResponse(e):M(e.type,new Error(`Unknown message: ${JSON.stringify(e)}`))}catch(t){this.log.reportError(t,{message:e})}});r(this,"latestDiscoveryInfo");r(this,"waitingDiscoveryMap",{});r(this,"reflectDiscoveredServices",()=>{let e=this.latestDiscoveryInfo?Object.keys(this.latestDiscoveryInfo.services):[],t;this.channel.disabled&&(e=Object.keys(this.waitingDiscoveryMap),t=new d.ServiceNotFound);for(let i of e){let o=this.waitingDiscoveryMap[i];o&&(this.waitingDiscoveryMap[i]=[],o.forEach(n=>t?n.reject(t):n.resolve()))}});r(this,"onDiscoveryResponse",e=>{if(w.isValidInfo(e.body))this.latestDiscoveryInfo=e.body,this.reflectDiscoveredServices(),this.log.trace("\u2198\uFE0F Discovered services",e.body);else throw new d.BadResponse("Invalid discovery response",e);e.id!==w.broadcastMessageId&&this.onResponse(e)});r(this,"broadcastDiscoveryInfo",e=>{let t={};for(let[o,n]of Object.entries(this.implementedServices)){let c=n.service;t[o]={fingerprint:c.fingerprint}}let i={services:t};try{this.channel.postMessage({type:h.MessageType.Response,id:e||w.broadcastMessageId,serviceId:w.serviceId,method:w.method,body:i})}catch{}});r(this,"onewayPromise",Promise.resolve(void 0));r(this,"expectWithoutDiscovery",e=>(this.log.trace("\u260E\uFE0F expectWithoutDiscovery",e.id),e.newOutgoingWrapper(async(t,i)=>t.oneway?(this.postOnewayRequest(e.id,t),this.onewayPromise):(await this.waitForDiscoveryInfo(1e3),this.throwErrorIfBadService(e),this.postRequest(e.id,t,void 0,i)))));r(this,"discover",async(e,{timeout:t=3e4}={})=>{this.log.trace("\u260E\uFE0F discover",e.id);let i=[this.waitForDiscoveredService(e,t)];return t!==1/0&&i.push(F(t).then(()=>{throw this.latestDiscoveryInfo?new d.ServiceNotFound(e.id):new d.TimedOut(e.id)})),await Promise.race(i),this.throwErrorIfBadService(e),this.expectWithoutDiscovery(e)});r(this,"throwErrorIfBadService",e=>{let t=this.latestDiscoveryInfo,i=t&&t?t.services[e.id]:void 0;if(!i)throw this.log.warn("\u260E\uFE0F Couldn't find service",e.id,t),new d.ServiceNotFound(e.id);if(i.fingerprint!==e.fingerprint)throw this.log.warn("\u260E\uFE0F Couldn't find service with required version fingerprint. Make sure both endpoints are using the same version of the Services package.",t),new d.ServiceNotCompatible(e.id)});r(this,"postOnewayRequest",(e,t)=>{this.channel.postMessage({type:h.MessageType.Request,id:h.onewayRequestId,serviceId:e,method:t.method,body:t.argument})});r(this,"postRequest",(e,t,i,o)=>{if(this.log.trace("\u2197\uFE0F",e,t),!!(this.channel.disabled??!1))return Promise.reject(new d.ServiceNotFound(e));let c={type:h.MessageType.Request,id:g.generateUniqueId(),serviceId:e,method:t.method,stream:C.toMessage(t.stream),body:t.argument},u=g.newResolvablePromise();this.waitingRequestsMap[c.id]={result:u,onStreamValue:o},this.channel.postMessage(c);let p=[u];return typeof i=="number"&&p.push(F(i).then(()=>{throw new d.TimedOut})),Promise.race(p).then(m=>m?.body).catch(m=>{throw delete this.waitingRequestsMap[c.id],m})});r(this,"waitingRequestsMap",{});r(this,"onResponse",e=>{let t=e.id,i=t.startsWith(h.onewayStreamResponseIdPrefix);i&&(t=t.substr(h.onewayStreamResponseIdPrefix.length));let o=this.waitingRequestsMap[t];if(i)o&&e.body&&o.onStreamValue?.(e.body);else{if(!o)return this.log.warn("\u260E\uFE0F onResponse: couldn't find request",e);delete this.waitingRequestsMap[t],o.result.resolve(e)}});r(this,"onErrorResponse",(e,t)=>{let i=this.waitingRequestsMap[e.id];if(!i)return this.log.warn("\u260E\uFE0F onErrorResponse: couldn't find request",e);delete this.waitingRequestsMap[e.id];let o=t||d.reconstructErrorResponse(e.body);i.result.reject(o)});r(this,"implementedServices",{});r(this,"unregisteredServices",new Set);r(this,"registerImplementation",(e,t)=>{this.log.trace("\u260E\uFE0F registerImplementation",t.id,e);let i={};for(let o in t.methods){let n=o,c=e[n];if(typeof c!="function")throw new d.Implementation(`Implementation for ${t.id} doesn't correctly implement ${n}()`);i[n]=c.bind(e)}this.unregisteredServices.delete(t.id),this.implementedServices[t.id]={service:t,rawImplementation:e,implementation:Object.freeze(i)},this.broadcastDiscoveryInfo()});r(this,"unregisterImplementation",async e=>{let t=e===this.unregisterAllToken;t||this.log.trace("\u260E\uFE0F unregisterImplementation",e);let i=!1,o=[];for(let[n,c]of Object.entries(this.implementedServices))if(!(!t&&c.rawImplementation!==e)){this.unregisteredServices.add(n),delete this.implementedServices[n],i=!0;for(let[u,p]of Object.entries(this.requestedStreamsMap))p?.serviceId===n&&o.push({id:u,error:new d.ServiceGone(n)})}await this.cancelStreams(o),i&&this.broadcastDiscoveryInfo()});r(this,"unregisterAllToken",{});r(this,"unregisterAllImplementations",async()=>{this.log.debug("\u260E\uFE0F unregisterAllImplementations"),await this.unregisterImplementation(this.unregisterAllToken)});r(this,"requestedStreamsMap",{});r(this,"cancelStreams",async e=>{let t=[];for(let{id:i,error:o}of e){let n=this.requestedStreamsMap[i];delete this.requestedStreamsMap[i],n?.iterator.throw&&t.push(n.iterator.throw(o))}await Promise.all(t)});r(this,"onRequest",async e=>{if(e.method===w.method){this.broadcastDiscoveryInfo(e.id);return}let t=h.MessageType.Response,i,o=!1;try{let n=this.implementedServices[e.serviceId],c=n?.implementation;if(!c)throw this.unregisteredServices.has(e.serviceId)?new d.ServiceGone(e.serviceId):new d.BadRequest;this.log.trace("\u2198\uFE0F",e.serviceId,e);let u=c[e.method];if(!e.stream)i=await u(e.body);else{let{id:p,method:m}=C.fromMessage(e.stream),I=this.requestedStreamsMap[p];if(m==="next"){if(!I){let v=b.isServiceStreamOptions(e.body)?e.body:void 0;I={iterator:(await u(v))[Symbol.asyncIterator](v?.oneway?f=>(this.channel.postMessage({type:h.MessageType.Response,id:h.onewayStreamResponseIdPrefix+e.id,serviceId:e.serviceId,method:e.method,body:{done:!1,value:f}}),{ignore:!0}):void 0),serviceId:n.service.id},this.requestedStreamsMap[p]=I}try{let v=await I.iterator.next();i={done:v.done,value:v.value}}catch(v){throw o=v instanceof d.ServiceGone,v}}else if(m==="return"){delete this.requestedStreamsMap[p];let v=I?.iterator.return;v&&await v(),i={done:!0,value:void 0}}else throw new d.BadRequest("Stream operations other than next() and return() are not yet supported")}}catch(n){t=h.MessageType.Error,i=d.toMessageBody(n),o||this.log.warn("\u260E\uFE0F onRequest: error",e,n)}finally{this.channel.postMessage({type:t,id:e.id,serviceId:e.serviceId,method:e.method,body:i})}});r(this,"onOnewayRequest",e=>{try{let i=this.implementedServices[e.serviceId]?.implementation;if(!i)throw this.unregisteredServices.has(e.serviceId)?new d.ServiceGone(e.serviceId):new d.BadRequest;this.log.trace("\u2198\uFE0F",e.serviceId,e);let o=i[e.method];o(e.body)}catch(t){this.log.warn("\u260E\uFE0F onOnewayRequest: error",e,t)}});r(this,"testable",{waitingRequestsMap:()=>this.waitingRequestsMap});e.addMessageListener(this.onMessage)}get log(){return this.customLogger??S.log}destroy(){this.channel.removeMessageListener(this.onMessage)}async waitForDiscoveryInfo(e,t=0){if(this.latestDiscoveryInfo)return this.latestDiscoveryInfo;let i=e/(t+1),o=0;for(;o<=t;)try{await this.postRequest(w.serviceId,{method:w.method},i);break}catch(n){if(!(n instanceof d.TimedOut))throw n;if(!this.isWaitingForDiscovery())break;o++}if(!this.latestDiscoveryInfo)throw new d.ServiceNotFound;return this.latestDiscoveryInfo}isWaitingForDiscovery(){return Object.values(this.waitingDiscoveryMap).some(e=>e&&e.length>0)}async waitForDiscoveredService(e,t){let i=g.newResolvablePromise(),o=this.waitingDiscoveryMap[e.id]||[],n=this.isWaitingForDiscovery();return this.waitingDiscoveryMap[e.id]=o,o.push(i),n||this.waitForDiscoveryInfo(t,2).catch(()=>{}),this.reflectDiscoveredServices(),i}},w;(o=>{o.serviceId="",o.method="#discover",o.broadcastMessageId="";function i(n){return!!(n&&typeof n=="object"&&"services"in n&&typeof n.services=="object")}o.isValidInfo=i})(w||={});var C;(o=>{let s="#return:",e="#throw:";function t(n){return n.startsWith(s)?{id:n.substr(s.length),method:"return"}:n.startsWith(e)?{id:n.substr(e.length),method:"throw"}:{id:n,method:"next"}}o.fromMessage=t;function i(n){if(n)switch(n.method){case"next":return n.id;case"return":return s+n.id;case"throw":return e+n.id;default:return}}o.toMessage=i})(C||={});function F(s){return new Promise(e=>{setTimeout(e,s)})}var k=class{constructor(){r(this,"listeners",new Set)}get log(){return S.log.extend("LocalChannel")}postMessage(e){this.log.trace("\u2197\uFE0E",e),this.listeners.forEach(t=>t(e))}addMessageListener(e){this.listeners.add(e)}removeMessageListener(e){this.listeners.delete(e)}},ce=new k;var V=class{constructor(e){this.port=e;r(this,"listeners",new Set);r(this,"onMessageEvent",e=>{this.log.trace(e);let t=e.data;if(h.isMessage(t))for(let i of this.listeners)i(t)})}get log(){return S.log.extend("MessagePortChannel")}postMessage(e){this.log.trace("\u2197\uFE0E",e),this.port.postMessage(e)}addMessageListener(e){this.listeners.size===0&&(this.port.start(),this.port.addEventListener("message",this.onMessageEvent,!1)),this.listeners.add(e)}removeMessageListener(e){this.listeners.delete(e),this.listeners.size===0&&this.port.removeEventListener("message",this.onMessageEvent,!1)}};var L=class{constructor(){r(this,"hook");r(this,"onNewStream");r(this,"newStream",e=>{let t=g.generateUniqueId();return new P((i,o)=>{this.iterators.push({id:t,update:i,done:o});let n=this.onNewStream?.(e);if(e?.replay==="latest"){let c=n?.latest??this.latestValue;if(c)i(c);else throw new d.Implementation('ServiceEventEmitter needs a "latest" value, but nothing has been emitted or returned by the onNewStream callback')}else if(n)throw new d.Implementation(`ServiceEventEmitter received a "latest" value from the onNewStream callback for a stream that didn't need it`)},()=>{let i=this.iterators.findIndex(o=>o.id===t);if(i>=0)this.iterators.splice(i,1);else throw new d.BadRequest(`ServiceEventEmitter couldn't find cancelled iterator with id: ${t}`)})});r(this,"iterators",[]);r(this,"latestValue");r(this,"emit",e=>{this.hook?.(e),this.latestValue=e;for(let t of this.iterators)t.update(e)});r(this,"latest",()=>this.latestValue);r(this,"hasStreams",()=>this.iterators.length>0)}setHook(e){this.hook=e}},P=class{constructor(e,t){this.onIteratorEnd=t;r(this,"log",S.log.extend("ServiceStreamIterator"));r(this,"hasAsyncIterator",!1);r(this,"updatesBeforeAsyncIterator",[]);r(this,"onUpdate");r(this,"doneResult",{done:!0,value:void 0});r(this,"promises",[]);r(this,"returnedNextPromise");r(this,"update",e=>{let{hasAsyncIterator:t,updatesBeforeAsyncIterator:i,promises:o,returnedNextPromise:n}=this;if(!t){if(!e||e instanceof d)throw new d.BadRequest("ServiceStream received return or throw before being read");i.push(e);return}let c=o[this.promises.length-1];if(e&&c===void 0){if(!n){this.log.warn("lastPromise and returnedNextPromise should never both be undefined");return}c=n}if(e===void 0)c?.resolve(this.doneResult),n?.resolve(this.doneResult);else if(e instanceof d)n?.reject(e);else{if(this.onUpdate?.(e).ignore)return;o.push(g.newResolvablePromise()),c?.resolve({done:!1,value:e})}});r(this,"next",async()=>{let e=this.promises.shift();return this.returnedNextPromise=e,e||this.doneResult});r(this,"return",async()=>(this.update(void 0),this.onIteratorEnd?.(),this.doneResult));r(this,"throw",async e=>(this.update(e),this.onIteratorEnd?.(),this.doneResult));r(this,"read",async e=>{let t=this[Symbol.asyncIterator](),i=await t.next();for(;!i.done;)e(i.value),i=await t.next()});r(this,"cancel",async()=>{await this.return()});this.promises=[g.newResolvablePromise()],e(this.update,this.update)}[Symbol.asyncIterator](e){if(this.hasAsyncIterator)throw new Error("ServiceStreamIterator.asyncIterator() may only be called once");return this.onUpdate=e,this.hasAsyncIterator=!0,this.updatesBeforeAsyncIterator.forEach(this.update),this.updatesBeforeAsyncIterator=[],this}};var U;(o=>{function s(n,c,u,p){u({method:n,argument:c?p:void 0,oneway:!0})}o.onewayMethodTemplate=s;async function e(n,c,u,p){await u({method:n,argument:c?p:void 0})}o.voidMethodTemplate=e;async function t(n,c,u,p){return await u({method:n,argument:c?p:void 0})}o.valueMethodTemplate=t;function i(n,c,u){return new b.StreamReader(n,u,c)}o.streamMethodTemplate=i})(U||={});export{M as a,d as b,$ as c,T as d,ce as e,V as f,U as g,L as h};
//# sourceMappingURL=https://app.framerstatic.com/chunk-AGVZOAU6.mjs.map
